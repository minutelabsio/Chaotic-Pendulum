/**
 * PhysicsJS v0.6.0 - 2014-04-22
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

/*
 * @license
 * Modified version of:
 * Lo-Dash 2.4.1 (Custom Build) <http://lodash.com/>
 * Copyright 2012-2013 The Dojo Foundation <http://dojofoundation.org/>
 * Based on Underscore.js 1.5.2 <http://underscorejs.org/LICENSE>
 * Copyright 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 * Available under MIT license <http://lodash.com/license>
 */

(function(e,t){typeof exports=="object"?module.exports=t.call(e):typeof define=="function"&&define.amd?define([],function(){return t.call(e)}):e.Physics=t.call(e)})(this,function(){var e=this,t=e.document,n=function i(){return i.world.apply(i,arguments)};n.util={},function(){n.aabb=function(e,t,n,r){var i={x:0,y:0,hw:0,hh:0};return e===undefined?i:(e&&e.x!==undefined&&(n=t.x,r=t.y,t=e.y,e=e.x),r===undefined&&e!==undefined&&t!==undefined?(i.hw=e*.5,i.hh=t*.5,n&&n.x!==undefined&&(i.x=n.x,i.y=n.y),i):(i.hw=Math.abs(n-e)*.5,i.hh=Math.abs(r-t)*.5,i.x=(n+e)*.5,i.y=(r+t)*.5,i))},n.aabb.contains=function(t,n){return n.x>t.x-t.hw&&n.x<t.x+t.hw&&n.y>t.y-t.hh&&n.y<t.y+t.hh},n.aabb.clone=function(e){return{x:e.x,y:e.y,hw:e.hw,hh:e.hh}},n.aabb.overlap=function(e,t){var n=e.x-e.hw,r=t.x-t.hw,i=e.x+e.hw,s=t.x+t.hw;return r<=i&&i<=s||n<=s&&s<=i?(n=e.y-e.hh,r=t.y-t.hh,i=e.y+e.hh,s=t.y+t.hh,r<=i&&i<=s||n<=s&&s<=i):!1}}(),function(){var e=1e-4,t=100,r=function(t,n,r){var i=n.normSq()-n.dot(t),s=n.dot(t)-t.normSq();return i<0?r.clone(n).negate():s>0?r.clone(t).negate():(r.clone(n).vsub(t),r.perp(t.cross(r)>0))},i=function(t){var r=t.length,i=t[r-2],s=t[r-3],o=n.scratchpad(),u=o.vector().clone(i.pt),a=o.vector().clone(s.pt).vsub(u),f,l;return a.equals(n.vector.zero)?o.done({a:i.a,b:i.b}):(f=-a.dot(u)/a.normSq(),l=1-f,l<=0?o.done({a:s.a,b:s.b}):f<=0?o.done({a:i.a,b:i.b}):o.done({a:u.clone(i.a).mult(l).vadd(a.clone(s.a).mult(f)).values(),b:u.clone(i.b).mult(l).vadd(a.clone(s.b).mult(f)).values()}))},s=function(o,u,a,f){var l=!1,c=!1,h=!1,p=[],d=1,v=n.scratchpad(),m=v.vector().clone(u||n.vector.axis[0]),g=v.vector(),y=v.vector(),b=v.vector(),w=v.vector(),E,S,x,T,N=0;T=o(m),d=p.push(T),g.clone(T.pt),m.negate();while(++N){g.swap(y),T=o(m),d=p.push(T),g.clone(T.pt),f&&f(p);if(g.equals(n.vector.zero)){l=!0;break}if(!c&&g.dot(m)<=0){if(a)break;c=!0}if(d===2)m=r(g,y,m);else if(c){m.normalize(),T=y.dot(m);if(Math.abs(T-g.dot(m))<e){h=-T;break}y.normSq()<b.clone(p[0].pt).normSq()?p.shift():p.splice(1,1),m=r(b.clone(p[1].pt),w.clone(p[0].pt),m)}else{E=E||v.vector(),S=S||v.vector(),E.clone(y).vsub(g),S.clone(p[0].pt).vsub(g),x=E.cross(S)>0;if(x^g.cross(E)>0)p.shift(),E.perp(!x),m.swap(E);else{if(!(x^S.cross(g)>0)){l=!0;break}p.splice(1,1),S.perp(x),m.swap(E)}}if(N>t)return v.done(),{simplex:p,iterations:N,distance:0,maxIterationsReached:!0}}return v.done(),T={overlap:l,simplex:p,iterations:N},h!==!1&&(T.distance=h,T.closest=i(p)),T};n.gjk=s}(),function(){var e=function t(e,r,i){if(!(this instanceof t))return new t(e,r);this.v=n.vector(),this.o=n.vector();if(e instanceof t){this.clone(e);return}e&&this.setTranslation(e),this.setRotation(r||0,i)};e.prototype.setTranslation=function(e){return this.v.clone(e),this},e.prototype.setRotation=function(e,t){return this.cosA=Math.cos(e),this.sinA=Math.sin(e),t?this.o.clone(t):this.o.zero(),this},e.prototype.clone=function(t){return t?(this.setTranslation(t.v),this.cosA=t.cosA,this.sinA=t.sinA,this.o.clone(t.o),this):new e(this)},n.transform=e}(),function(e){var t=Math.sqrt,r=Math.min,i=Math.max,s=Math.acos,o=Math.atan2,u=Math.PI*2,a=!!e.Float64Array,f=function l(e,t){if(!(this instanceof l))return new l(e,t);a?this._=new Float64Array(5):this._=[],e&&(e.x!==undefined||e._&&e._.length)?this.clone(e):(this.recalc=!0,this.set(e,t))};Object.defineProperties(f.prototype,{x:{get:function(){return+this._[0]},set:function(e){e=+e||0,this.recalc=e===this._[0],this._[0]=e}},y:{get:function(){return+this._[1]},set:function(e){e=+e||0,this.recalc=e===this._[1],this._[1]=e}}}),f.prototype.set=function(e,t){return this.recalc=!0,this._[0]=+e||0,this._[1]=+t||0,this},f.prototype.get=function(e){return this._[e]},f.prototype.vadd=function(e){return this.recalc=!0,this._[0]+=e._[0],this._[1]+=e._[1],this},f.prototype.vsub=function(e){return this.recalc=!0,this._[0]-=e._[0],this._[1]-=e._[1],this},f.prototype.add=function(e,t){return this.recalc=!0,this._[0]+=+e||0,this._[1]+=+t||0,this},f.prototype.sub=function(e,t){return this.recalc=!0,this._[0]-=e,this._[1]-=t===undefined?0:t,this},f.prototype.mult=function(e){return this.recalc||(this._[4]*=e*e,this._[3]*=e),this._[0]*=e,this._[1]*=e,this},f.prototype.dot=function(e){return this._[0]*e._[0]+this._[1]*e._[1]},f.prototype.cross=function(e){return-this._[0]*e._[1]+this._[1]*e._[0]},f.prototype.proj=function(e){return this.dot(e)/e.norm()},f.prototype.vproj=function(e){var t=this.dot(e)/e.normSq();return this.clone(e).mult(t)},f.prototype.angle=function(e){var t;if(this.equals(f.zero))return e?e.angle():NaN;e&&!e.equals(f.zero)?t=o(this._[1]*e._[0]-this._[0]*e._[1],this._[0]*e._[0]+this._[1]*e._[1]):t=o(this._[1],this._[0]);while(t>Math.PI)t-=u;while(t<-Math.PI)t+=u;return t},f.prototype.angle2=function(e,t){var n=e._[0]-this._[0],r=e._[1]-this._[1],i=t._[0]-this._[0],s=t._[1]-this._[1],a=o(r*i-n*s,n*i+r*s);while(a>Math.PI)a-=u;while(a<-Math.PI)a+=u;return a},f.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[3]},f.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[4]},f.prototype.dist=function(e){var n,r;return t((n=e._[0]-this._[0])*n+(r=e._[1]-this._[1])*r)},f.prototype.distSq=function(e){var t,n;return(t=e._[0]-this._[0])*t+(n=e._[1]-this._[1])*n},f.prototype.perp=function(e){var t=this._[0];return e?(this._[0]=this._[1],this._[1]=-t):(this._[0]=-this._[1],this._[1]=t),this},f.prototype.normalize=function(){var e=this.norm();return e===0?this:(e=1/e,this._[0]*=e,this._[1]*=e,this._[3]=1,this._[4]=1,this)},f.prototype.transform=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r,this._[1]-=i,this.set(this._[0]*n-this._[1]*t+r+e.v._[0],this._[0]*t+this._[1]*n+i+e.v._[1])},f.prototype.transformInv=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r+e.v._[0],this._[1]-=i+e.v._[1],this.set(this._[0]*n+this._[1]*t+r,-this._[0]*t+this._[1]*n+i)},f.prototype.rotate=function(e,t){var n,r,i=0,s=0;return typeof e=="number"?(n=Math.sin(e),r=Math.cos(e),t&&(i=(t.x||t._[0])|0,s=(t.y||t._[1])|0)):(n=e.sinA,r=e.cosA,i=e.o._[0],s=e.o._[1]),this._[0]-=i,this._[1]-=s,this.set(this._[0]*r-this._[1]*n+i,this._[0]*n+this._[1]*r+s)},f.prototype.rotateInv=function(e){return this.set((this._[0]-e.o._[0])*e.cosA+(this._[1]-e.o._[1])*e.sinA+e.o._[0],-(this._[0]-e.o._[0])*e.sinA+(this._[1]-e.o._[1])*e.cosA+e.o._[1])},f.prototype.translate=function(e){return this.vadd(e.v)},f.prototype.translateInv=function(e){return this.vsub(e.v)},f.prototype.clone=function(e){return e?e._?(this.recalc=e.recalc,e.recalc||(this._[3]=e._[3],this._[4]=e._[4]),this._[0]=e._[0],this._[1]=e._[1],this):this.set(e.x,e.y):new f(this)},f.prototype.swap=function(e){var t=this._;return this._=e._,e._=t,t=this.recalc,this.recalc=e.recalc,e.recalc=t,this},f.prototype.values=function(){return{x:this._[0],y:this._[1]}},f.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},f.prototype.negate=function(e){return e!==undefined?(this._[e]=-this._[e],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},f.prototype.clamp=function(e,t){return this._[0]=r(i(this._[0],e.x),t.x),this._[1]=r(i(this._[1],e.y),t.y),this.recalc=!0,this},f.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},f.prototype.equals=function(e){return this._[0]===e._[0]&&this._[1]===e._[1]&&this._[2]===e._[2]},f.axis=[new f(1,0),new f(0,1)],f.zero=new f(0,0),n.vector=f}(this),function(e){var t=e.Physics;n.noConflict=function(){return e.Physics===n&&(e.Physics=t),n}}(this);var r=n.util.decorator=function(t,r){var i={},s={},o=function(t,r){var i,s;for(s in r)i=Object.getOwnPropertyDescriptor(r,s),i.get||i.set?Object.defineProperty(t,s,i):n.util.isFunction(i.value)&&(t[s]=i.value);return t},u=Object.getPrototypeOf;typeof u!="function"&&(typeof "test".__proto__=="object"?u=function(e){return e.__proto__}:u=function(e){return e.constructor.prototype});var a=Object.create;typeof a!="function"&&(a=function(e){function t(){}return t.prototype=e,new t});var f=function(r,i){if(typeof r=="object"){s=o(s,r),s.type=t;return}r!=="type"&&n.util.isFunction(i)&&(s[r]=i)};f(r);var l=function(n,r,f,l){var c,h,p=s,d;if(typeof r!="string")l=f,f=r;else{p=i[r];if(!p)throw'Error: "'+r+'" '+t+" not defined";p=p.prototype}if(typeof f=="function")h=i[n],h?h.prototype=o(h.prototype,f(u(h.prototype))):(h=i[n]=function v(e){this.init&&this.init(e)},h.prototype=a(p),h.prototype=o(h.prototype,f(p,h.prototype))),h.prototype.type=t,h.prototype.name=n;else{l=f||{},h=i[n];if(!h)throw'Error: "'+n+'" '+t+" not defined"}if(l)return new h(l)};return l.mixin=f,l};return n.util.indexOf=function(t,n){var r=0,i=t.length;while(r<i){i--;if(t[r]===n)return r;if(t[i]===n)return i;r++}return-1},n.util.throttle=function(t,n,r){var i,s=!1,o,u=function(){clearTimeout(i),s?(s=!1,i=setTimeout(u,n),t.apply(r,o)):i=!1};return r=r||null,function(){s=!0,o=arguments,i||u()}},n.util.options=function(e,t){var r={},i,s=[];return i=function(r){n.util.extend(t,r,null);for(var i=0,o=s.length;i<o;++i)s[i](t);return t},i.defaults=function(i){return n.util.extend(r,i),n.util.defaults(t,r),r},i.onChange=function(e){s.push(e)},t=t||i,i.defaults(e),i},n.util.pairHash=function(e,t){return e|=0,t|=0,(e|0)===(t|0)?-1:((e|0)>(t|0)?e<<16|t&65535:t<<16|e&65535)|0},Function.prototype.bind?n.util.bind=function(e,t,n){return n=Array.prototype.slice.call(arguments,1),Function.prototype.bind.apply(e,n)}:n.util.bind=function(e,t,n){return n=Array.prototype.slice.call(arguments,2),function(){return e.apply(t,n.concat(Array.prototype.slice.call(arguments)))}},n.util.find=function(e,t){var n,r=e.length,i;for(n=0;n<r;n++){i=e[n];if(t(i,n,e))return i}},n.util.filter=function(e,t){var n,r=e.length,i,s=[];for(n=0;n<r;n++)i=e[n],t(i,n,e)&&s.push(i);return s},function(){function p(e){e.length=0,f.length<c&&f.push(e)}function d(e){var t=e.cache;t&&d(t),e.array=e.cache=e.criteria=e.object=e.number=e.string=e.value=null,l.length<c&&l.push(e)}function v(){return l.pop()||{array:null,cache:null,criteria:null,"false":!1,index:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,"undefined":!1,value:null}}function m(){return f.pop()||[]}function g(e,t){var r=typeof t;e=e.cache;if(r==="boolean"||t==null)return e[t]?0:-1;r!=="number"&&r!=="string"&&(r="object");var i=r==="number"?t:h+t;return e=(e=e[r])&&e[i],r==="object"?e&&n.util.indexOf(e,t)>-1?0:-1:e?0:-1}function y(e){var t=this.cache,n=typeof e;if(n==="boolean"||e==null)t[e]=!0;else{n!=="number"&&n!=="string"&&(n="object");var r=n==="number"?e:h+e,i=t[n]||(t[n]={});n==="object"?(i[r]||(i[r]=[])).push(e):i[r]=!0}}function b(e){var t=-1,n=e.length,r=e[0],i=e[n/2|0],s=e[n-1];if(r&&typeof r=="object"&&i&&typeof i=="object"&&s&&typeof s=="object")return!1;var o=v();o["false"]=o["null"]=o["true"]=o["undefined"]=!1;var u=v();u.array=e,u.cache=o,u.push=y;while(++t<n)u.push(e[t]);return u}function x(e,t){return e+Math.floor(Math.random()*(t-e+1))}function T(e){return typeof e=="function"}function C(e){return typeof e=="function"&&N.test(e)}function k(e){var t,n;if(!!e&&o.call(e)===i&&(t=e.constructor,!T(t)||t instanceof t)){for(var r in e)n=r;return typeof n=="undefined"||u.call(e,n)}return!1}function L(e,t,r){var i=-1,s=n.util.indexOf,o=e?e.length:0,u=[],f=!t&&o>=a&&s===n.util.indexOf,l=r||f?m():u;if(f){var c=b(l);s=g,l=c}while(++i<o){var h=e[i],v=r?r(h,i,e):h;if(t?!i||l[l.length-1]!==v:s(l,v)<0)(r||f)&&l.push(v),u.push(h)}return f?(p(l.array),d(l)):r&&p(l),u}var e={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},t=function(e){return e},r="[object Array]",i="[object Object]",s=Object.keys,o=Object.prototype.toString,u=Object.prototype.hasOwnProperty,a=75,f=[],l=[],c=40,h=+(new Date)+"",w=function(t){var n,r=t,i=[];if(!r)return i;if(!e[typeof t])return i;for(n in r)u.call(r,n)&&i.push(n);return i},E=s?function(e){return n.util.isObject(e)?s(e):[]}:w,S=0;n.util.uniqueId=function(t){var n=++S;return""+(t||"")+n},n.util.shuffle=function(e){var t=-1,n=e?e.length:0,r=Array(typeof n=="number"?n:0),i,s,o,u;for(i=0,s=e.length;i<s;i++)o=e[i],u=x(0,++t),r[t]=r[u],r[u]=o;return r},n.util.isObject=function(n){return!!n&&!!e[typeof n]},n.util.isFunction=T,n.util.isArray=Array.isArray||function(e){return e&&typeof e=="object"&&typeof e.length=="number"&&o.call(e)===r||!1};var N=RegExp("^"+String(o).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");n.util.isPlainObject=Object.getPrototypeOf?function(e){if(!e||o.call(e)!==i)return!1;var t=e.valueOf,n=C(t)&&(n=Object.getPrototypeOf(t))&&Object.getPrototypeOf(n);return n?e===n||Object.getPrototypeOf(e)===n:k(e)}:k,n.util.uniq=function(t,n,r){return typeof n!="boolean"&&n!=null&&(r=n,n=!1),L(t,n,r)};var A=function(t,n,r){var i,s=t,o=s;if(!s)return o;var u=arguments,a=0,f,l=typeof r=="number"?2:u.length;l>2&&typeof u[l-1]=="function"&&(f=u[--l]);while(++a<l){s=u[a];if(s&&e[typeof s]){var c=-1,h=e[typeof s]&&E(s),p=h?h.length:0;while(++c<p)i=h[c],o[i]=f?f(o[i],s[i]):s[i]}}return o};n.util.extend=A,n.util.defaults=function(t,n,r){var i,s=t,o=s;if(!s)return o;var u=arguments,a=0,f=typeof r=="number"?2:u.length;while(++a<f){s=u[a];if(s&&e[typeof s]){var l=-1,c=e[typeof s]&&E(s),h=c?c.length:0;while(++l<h)i=c[l],typeof o[i]=="undefined"&&(o[i]=s[i])}}return o},n.util.sortedIndex=function(n,r,i){var s=0,o=n?n.length:s;i=i||t,r=i(r);while(s<o){var u=s+o>>>1;i(n[u])<r?s=u+1:o=u}return s}}(),n.scratchpad=function(){var e="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",t="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",r="Error: Too many scratchpads created. (Did you forget to call .done()?)",i="Error: Object is already registered.",s=[],o=0,u,a,f=0;return u=function(){this._active=!1,this._indexArr=[];if(++o>=a.maxScratches)throw r},u.prototype={done:function(e){this._active=!1;var t;for(var n=0;n<f;++n)this[n]=0;return s.push(this),e}},a=function l(e){if(e)return l.fn(e);var t=s.pop()||new u;return t._active=!0,t},a.maxScratches=100,a.maxIndex=20,a.fn=function(e){var t=[];for(var n=0,r=e.length;n<r;n++)t.push(n);t="a"+t.join(",a");var i=new Function("fn, scratches, Scratch","return function("+t+"){ "+"var scratch = scratches.pop() || new Scratch( scratches );"+"scratch._active = true;"+"return scratch.done( fn(scratch, "+t+") );"+"};");return i(e,s,u)},a.register=function(r,s,o){var l=u.prototype,c=f++,h="_"+r+"Stack",p=o&&o.useFactory;if(r in l)throw i;l[r]=function(){var n=this[h]||(this[h]=[]),r=this[c]|0;this[c]=r+1;if(!this._active)throw e;if(r>=a.maxIndex)throw t;return n[r]||(n[r]=p?s():new s)}},a.register("vector",n.vector),a.register("transform",n.transform),a}(),function(){function e(e){return e._priority_}n.scratchpad.register("event",function(){return{}},{useFactory:!0});var t=function r(){if(!(this instanceof r))return new r};t.prototype={on:function(t,r,i,s){var o,u,a;this._topics=this._topics||(this._topics={});if(n.util.isObject(t)){for(var f in t)this.on(f,t[f],r,i);return this}return o=this._topics[t]||(this._topics[t]=[]),u=r,n.util.isObject(i)?(r=n.util.bind(r,i),r._bindfn_=u,r._one_=u._one_):s||(s=i),r._priority_=s,a=n.util.sortedIndex(o,r,e),o.splice(a,0,r),this},off:function(e,t){var r,i;if(!this._topics)return this;if(e===!0)return this._topics={},this;if(n.util.isObject(e)){for(var s in e)this.off(s,e[s]);return this}r=this._topics[e];if(!r)return this;if(t===!0)return this._topics[e]=[],this;for(var o=0,u=r.length;o<u;o++){i=r[o];if(i._bindfn_===t||i===t){r.splice(o,1);break}}return this},emit:function(e,t){if(!this._topics)return this;var r=this._topics[e],i=r&&r.length,s,o,u=n.scratchpad();if(!i)return u.done(this);o=u.event(),o.topic=e,o.handler=s;while(i--)s=r[i],s(t,o),s._one_&&r.splice(i,1);return u.done(this)},one:function(e,t,r){if(n.util.isObject(e)){for(var i in e)this.one(i,e[i],t,r);return this}return t._one_=!0,this.on(e,t,r),this}},n.util.pubsub=t}(),function(e){function s(){return i&&i.now?i.now()+i.timing.navigationStart:Date.now()}function o(){var n;if(!t)return;n=s();if(!n)return;e.requestAnimationFrame(o),r.emit("tick",n)}function u(){return t=!0,o(),this}function a(){return t=!1,this}function f(e){return r.on("tick",e),this}function l(e){return r.off("tick",e),this}function c(){return!!t}var t=!1,r=n.util.pubsub(),i=e.performance;n.util.ticker={now:s,start:u,stop:a,on:f,off:l,isActive:c}}(this),function(e){var t=function(){return!0},r=n.util.indexOf,i=function(t,n){return function(e){return t(e[n])}},s=function(t,i){return function(e){e=i?e[i]:e;var s=0,o;if(n.util.isArray(e)){if(n.util.isArray(t)){o=e.length;if(o!==t.length)return!1;while(s<o){o--;if(r(t,e[s])===-1||r(t,e[o])===-1)return!1;s++}return!0}return r(e,t)>-1}return e===t}},o=function(t,n){var r=s(t,n);return function(e){return!r(e)}},u=function(t,i){return function(e){e=i?e[i]:e;var s=0,o;if(n.util.isArray(e)){o=e.length;while(s<o){o--;if(r(t,e[s])>-1||r(t,e[o])>-1)return!0;s++}return!1}return r(t,e)>-1}},a=function(t,n){var r=u(t,n);return function(e){return!r(e)}},f=function(t){return t=n.vector(t),function(e){var r=e.aabb();return n.aabb.contains(r,t)}},l=function(t){return t.next?function(e){var n=t;while(n){if(!n(e))return!1;n=n.next}return!0}:t},c=function(t){return t.next?function(e){var n=t;while(n){if(n(e))return!0;n=n.next}return!1}:t},h={$eq:s,$ne:o,$in:u,$nin:a,$at:f},p=function d(e,r){var o,u,a,f,p,v;if(r){if(r==="$or"||r==="$and"){for(o=0,u=e.length;o<u;++o)v=d(e[o]),p=p?p.next=v:f=v;return r==="$or"?c(f):l(f)}if(o=h[r])return o(e);throw"Unknown query operation: "+r}for(o in e)a=e[o],o[0]==="$"?v=d(a,o):n.util.isPlainObject(a)?v=i(d(a),o):v=s(a,o),p=p?p.next=v:f=v;return l(f||t)};n.query=p}(this),function(){var e={priority:0};n.behavior=r("behavior",{init:function(t){this.options=n.util.options(e),this.options(t)},applyTo:function(e){return e===!0?this._targets=null:this._targets=n.util.uniq(e),this},getTargets:function(){return this._targets||(this._world?this._world._bodies:[])},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},connect:function(e){this.behave&&e.on("integrate:positions",this.behave,this,this.options.priority)},disconnect:function(e){this.behave&&e.off("integrate:positions",this.behave)},behave:null})}(),function(){var e={hidden:!1,treatment:"dynamic",mass:1,restitution:1,cof:.8,view:null},t=1;n.body=r("body",{init:function(r){var i=n.vector;this.options=n.util.options(e,this),this.options(r),this.state={pos:i(this.x,this.y),vel:i(this.vx,this.vy),acc:i(),angular:{pos:this.angle||0,vel:this.angularVelocity||0,acc:0},old:{pos:i(),vel:i(),acc:i(),angular:{pos:0,vel:0,acc:0}}},delete this.x,delete this.y,delete this.vx,delete this.vy,delete this.angle,delete this.angularVelocity;if(this.mass===0)throw"Error: Bodies must have non-zero mass";this.uid=t++,this.geometry=n.geometry("point")},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},accelerate:function(e){return this.treatment==="dynamic"&&this.state.acc.vadd(e),this},applyForce:function(e,t){if(this.treatment!=="dynamic")return this;var r=n.scratchpad(),i=r.vector(),s;return t&&this.moi&&(s=this.state,i.clone(t),this.state.angular.acc-=i.cross(e)/this.moi),this.accelerate(i.clone(e).mult(1/this.mass)),r.done(),this},aabb:function(){var e=this.state.angular.pos,t=this.geometry.aabb(e);return t.x+=this.state.pos.x,t.y+=this.state.pos.y,t},recalc:function(){return this}})}(),function(){n.geometry=r("geometry",{init:function(e){this.options=n.util.options(),this.options(e),this._aabb=new n.aabb},aabb:function(e){return n.aabb.clone(this._aabb)},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.set(0,0)},getFarthestCorePoint:function(e,t,r){return t=t||n.vector(),t.set(0,0)}})}(),n.geometry.isPolygonConvex=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=t.vector(),o=!0,u=!1,a=e.length;if(!e||!a)return!1;if(a<3)return t.done(),o;r.clone(e[0]).vsub(s.clone(e[a-1]));for(var f=1;f<=a;++f){i.clone(e[f%a]).vsub(s.clone(e[(f-1)%a]));if(u===!1)u=r.cross(i);else if(u>0^r.cross(i)>0){o=!1;break}i.swap(r)}return t.done(),o},n.geometry.getPolygonMOI=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=0,o=0,u,a=e.length;if(a<2)return t.done(),0;if(a===2)return u=i.clone(e[1]).distSq(r.clone(e[0])),t.done(),u/12;r.clone(e[0]);for(var f=1;f<a;++f)i.clone(e[f]),u=Math.abs(i.cross(r)),s+=u*(i.normSq()+i.dot(r)+r.normSq()),o+=u,r.swap(i);return t.done(),s/(6*o)},n.geometry.isPointInPolygon=function(e,t){var r=n.scratchpad(),i=r.vector().clone(e),s=r.vector(),o=r.vector(),u=0,a=t.length;if(a<2)return u=i.equals(s.clone(t[0])),r.done(),u;if(a===2)return u=i.angle(s.clone(t[0])),u+=i.angle(s.clone(t[1])),r.done(),Math.abs(u)===Math.PI;s.clone(t[0]).vsub(i);for(var f=1;f<=a;++f)o.clone(t[f%a]).vsub(i),u+=o.angle(s),s.swap(o);return r.done(),Math.abs(u)>1e-6},n.geometry.getPolygonArea=function(t){var r=n.scratchpad(),i=r.vector(),s=r.vector(),o=0,u=t.length;if(u<3)return r.done(),0;i.clone(t[u-1]);for(var a=0;a<u;++a)s.clone(t[a]),o+=i.cross(s),i.swap(s);return r.done(),o/2},n.geometry.getPolygonCentroid=function(t){var r=n.scratchpad(),i=r.vector(),s=r.vector(),o=n.vector(),u,a=t.length;if(a<2)return r.done(),n.vector(t[0]);if(a===2)return r.done(),n.vector((t[1].x+t[0].x)/2,(t[1].y+t[0].y)/2);i.clone(t[a-1]);for(var f=0;f<a;++f)s.clone(t[f]),u=i.cross(s),i.vadd(s).mult(u),o.vadd(i),i.swap(s);return u=1/(6*n.geometry.getPolygonArea(t)),r.done(),o.mult(u)},n.geometry.nearestPointOnLine=function(t,r,i){var s=n.scratchpad(),o=s.vector().clone(t),u=s.vector().clone(r).vsub(o),a=s.vector().clone(i).vsub(o).vsub(u),f,l;return a.equals(n.vector.zero)?(s.done(),n.vector(r)):(f=-a.dot(u)/a.normSq(),l=1-f,l<=0?(s.done(),n.vector(i)):f<=0?(s.done(),n.vector(r)):(o=n.vector(i).mult(f).vadd(u.clone(r).mult(l)),s.done(),o))},function(){var e={drag:0};n.integrator=r("integrator",{init:function(t){this.options=n.util.options(e)},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},integrate:function(e,t){var n=this._world;return this.integrateVelocities(e,t),n&&n.emit("integrate:velocities",{bodies:e,dt:t}),this.integratePositions(e,t),n&&n.emit("integrate:positions",{bodies:e,dt:t}),this},connect:null,disconnect:null,integrateVelocities:function(e,t){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(e,t){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var e={meta:!1,metaRefresh:200,width:600,height:600};n.renderer=r("renderer",{init:function(r){var i=typeof r.el=="string"?t.getElementById(r.el):r.el;this.options=n.util.extend({},e,r),this.el=i?i:t.body,this.drawMeta=n.util.throttle(n.util.bind(this.drawMeta,this),this.options.metaRefresh)},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},render:function(e,t){var n,r,i;this.beforeRender&&this.beforeRender(),this._world.emit("beforeRender",{renderer:this,bodies:e,meta:t}),this.options.meta&&this.drawMeta(t),this._interpolateTime=t.interpolateTime;for(var s=0,o=e.length;s<o;++s)n=e[s],r=n.view||(n.view=this.createView(n.geometry,n.styles)),n.hidden||this.drawBody(n,r);return this},createView:function(e,t){throw"You must override the renderer.createView() method."},drawMeta:function(e){throw"You must override the renderer.drawMeta() method."},drawBody:function(e,t){throw"You must override the renderer.drawBody() method."}})}(),function(){var e=function i(e,t,n){var r,s,o=function(){return i(e,t,n)};while(r=e.shift()){s=r.apply(t,n);if(s&&s.then)return s.then(o)}},t={timestep:1e3/120,maxIPF:16,webworker:!1,integrator:"verlet"},r=function s(e,t){if(!(this instanceof s))return new s(e,t);this.init(e,t)};r.prototype=n.util.extend({},n.util.pubsub.prototype,{init:function(r,i){var s=this;if(n.util.isFunction(r)||n.util.isArray(r))i=r,r={};this._meta={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._warp=1,this._time=0,this.options=n.util.options(t),this.options.onChange(function(e){s.timestep(e.timestep)}),this.options(r),this.add(n.integrator(this.options.integrator)),n.util.isFunction(i)?e([i],this,[this,n]):n.util.isArray(i)&&e(i,this,[this,n])},options:null,add:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.addBehavior(r);break;case"integrator":this.integrator(r);break;case"renderer":this.renderer(r);break;case"body":this.addBody(r);break;default:throw'Error: failed to add item of unknown type "'+r.type+'" to world'}while(++t<n&&(r=e[t]));return this},remove:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.removeBehavior(r);break;case"integrator":r===this._integrator&&this.integrator(null);break;case"renderer":r===this._renderer&&this.renderer(null);break;case"body":this.removeBody(r);break;default:throw'Error: failed to remove item of unknown type "'+r.type+'" from world'}while(++t<n&&(r=e[t]));return this},has:function(e){var t,r,i;if(!e)return!1;switch(e.type){case"behavior":t=this._behaviors;break;case"integrator":return this._integrator===e;case"renderer":return this._renderer===e;case"body":t=this._bodies;break;default:throw'Error: unknown type "'+e.type+'"'}return n.util.indexOf(t,e)>-1},integrator:function(e){return e===undefined?this._integrator:this._integrator===e?this:(this._integrator&&(this._integrator.setWorld(null),this.emit("remove:integrator",{integrator:this._integrator})),e&&(this._integrator=e,this._integrator.setWorld(this),this.emit("add:integrator",{integrator:this._integrator})),this)},renderer:function(e){return e===undefined?this._renderer:this._renderer===e?this:(this._renderer&&(this._renderer.setWorld(null),this.emit("remove:renderer",{renderer:this._renderer})),e&&(this._renderer=e,this._renderer.setWorld(this),this.emit("add:renderer",{renderer:this._renderer})),this)},timestep:function(e){return e?(this._dt=e,this._maxJump=e*this.options.maxIPF,this):this._dt},addBehavior:function(e){var t;return this.has(e)?this:(e.setWorld(this),this._behaviors.push(e),this.emit("add:behavior",{behavior:e}),this)},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(e){var t=this._behaviors;if(e)for(var n=0,r=t.length;n<r;++n)if(e===t[n]){t.splice(n,1),e.setWorld(null),this.emit("remove:behavior",{behavior:e});break}return this},addBody:function(e){var t;return this.has(e)?this:(e.setWorld(this),this._bodies.push(e),this.emit("add:body",{body:e}),this)},getBodies:function(){return[].concat(this._bodies)},removeBody:function(e){var t=this._bodies;if(e)for(var n=0,r=t.length;n<r;++n)if(e===t[n]){t.splice(n,1),e.setWorld(null),this.emit("remove:body",{body:e});break}return this},findOne:function(e){var t=this,r=typeof e=="function"?e:n.query(e);return n.util.find(t._bodies,r)||!1},find:function(e){var t=this,r=typeof e=="function"?e:n.query(e);return n.util.filter(t._bodies,r)},iterate:function(e){this._integrator.integrate(this._bodies,e)},step:function(e){var t=this._time,r=this._warp,i=1/r,s=this._dt,o=s*i,u=this._maxJump*i,a,f,l,c=this._meta;if(this._paused||this._animTime===undefined)return this._animTime=e||this._animTime||n.util.ticker.now(),this._paused||this.emit("step",c),this;e=e||this._animTime+o,a=e-this._animTime,a>u&&(this._animTime=e-u,a=u),f=a*r,l=t+f-s;if(t<=l)while(t<=l)t+=s,this._animTime+=o,this._time=t,this.iterate(s);return c.fps=1e3/(e-this._lastTime),c.ipf=(f/s).toFixed(2),c.interpolateTime=s+l-t,this._lastTime=e,this.emit("step",c),this},warp:function(e){return e===undefined?this._warp:(this._warp=e||1,this)},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._meta),this.emit("render",{bodies:this._bodies,meta:this._meta,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.emit("pause"),this},unpause:function(){return this._paused=!1,this.emit("unpause"),this},isPaused:function(){return!!this._paused},destroy:function(){var e=this;e.pause(),this.emit("destroy"),e.off(!0),e.remove(e.getBodies()),e.remove(e.getBehaviors()),e.integrator(null),e.renderer(null)}}),n.world=r}(),n.integrator("verlet",function(e){return n.body.mixin({started:function(e){return e!==undefined&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){var n=t*t,r=1-this.options.drag,i=null,s;for(var o=0,u=e.length;o<u;++o)i=e[o],s=i.state,i.treatment!=="static"?(s.vel.equals(s.old.vel)&&i.started()?s.vel.clone(s.pos).vsub(s.old.pos):(s.old.pos.clone(s.pos).vsub(s.vel),s.vel.mult(t)),r&&s.vel.mult(r),s.vel.vadd(s.acc.mult(n)),s.vel.mult(1/t),s.old.vel.clone(s.vel),s.acc.zero(),s.angular.vel===s.old.angular.vel&&i.started()?s.angular.vel=s.angular.pos-s.old.angular.pos:(s.old.angular.pos=s.angular.pos-s.angular.vel,s.angular.vel*=t),s.angular.vel+=s.angular.acc*n,s.angular.vel/=t,s.old.angular.vel=s.angular.vel,s.angular.acc=0,i.started(!0)):(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0)},integratePositions:function(e,t){var n=t*t,r=null,i;for(var s=0,o=e.length;s<o;++s)r=e[s],i=r.state,r.treatment!=="static"&&(i.vel.mult(t),i.old.pos.clone(i.pos),i.pos.vadd(i.vel),i.vel.mult(1/t),i.old.vel.clone(i.vel),i.angular.vel*=t,i.old.angular.pos=i.angular.pos,i.angular.pos+=i.angular.vel,i.angular.vel/=t,i.old.angular.vel=i.angular.vel)}}}),n.geometry("point",function(e){}),n.body("point",function(e){return{init:function(t){e.init.call(this,t),this.moi=0}}}),n.geometry("circle",function(e){var t={radius:1};return{init:function(r){var i=this;e.init.call(this,r),this.options.defaults(t),this.options.onChange(function(e){this.radius=e.radius}),this.options(r),this._aabb=n.aabb(),this.radius=this.options.radius},aabb:function(e){var t=this.radius;return this._aabb.hw!==t&&(this._aabb=n.aabb(-t,-t,t,t)),n.aabb.clone(this._aabb)},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.clone(e).normalize().mult(this.radius)},getFarthestCorePoint:function(e,t,r){return t=t||n.vector(),t.clone(e).normalize().mult(this.radius-r)}}}),n.geometry("convex-polygon",function(e){var t="Error: The vertices specified do not match that of a _convex_ polygon.",r={};return{init:function(t){var n=this;e.init.call(this,t),this.options.defaults(r),this.options.onChange(function(e){n.setVertices(e.vertices||[])}),this.options(t),n.setVertices(this.options.vertices||[])},setVertices:function(e){var r=n.scratchpad(),i=r.transform(),s=this.vertices=[];if(!n.geometry.isPolygonConvex(e))throw t;i.setRotation(0),i.setTranslation(n.geometry.getPolygonCentroid(e).negate());for(var o=0,u=e.length;o<u;++o)s.push(n.vector(e[o]).translate(i));return this._area=n.geometry.getPolygonArea(s),this._aabb=!1,r.done(),this},aabb:function(e){if(!e&&this._aabb)return n.aabb.clone(this._aabb);var t=n.scratchpad(),r=t.vector(),i=t.transform().setRotation(e||0),s=t.vector().set(1,0).rotateInv(i),o=t.vector().set(0,1).rotateInv(i),u=this.getFarthestHullPoint(s,r).proj(s),a=-this.getFarthestHullPoint(s.negate(),r).proj(s),f=this.getFarthestHullPoint(o,r).proj(o),l=-this.getFarthestHullPoint(o.negate(),r).proj(o),c;return c=n.aabb(a,l,u,f),e||(this._aabb=n.aabb.clone(c)),t.done(),c},getFarthestHullPoint:function(e,t,r){var i=this.vertices,s,o,u=i.length,a=2,f;t=t||n.vector();if(u<2)return r&&(r.idx=0),t.clone(i[0]);o=i[0].dot(e),s=i[1].dot(e);if(u===2)return f=s>=o?1:0,r&&(r.idx=f),t.clone(i[f]);if(s>=o){while(a<u&&s>=o)o=s,s=i[a].dot(e),a++;return s>=o&&a++,f=a-2,r&&(r.idx=a-2),t.clone(i[f])}a=u;while(a>1&&o>=s)a--,s=o,o=i[a].dot(e);return f=(a+1)%u,r&&(r.idx=f),t.clone(i[f])},getFarthestCorePoint:function(e,t,r){var i,s=n.scratchpad(),o=s.vector(),u=s.vector(),a=this.vertices,f=a.length,l,c=this._area>0,h={};return t=this.getFarthestHullPoint(e,t,h),o.clone(a[(h.idx+1)%f]).vsub(t).normalize().perp(c),u.clone(a[(h.idx-1+f)%f]).vsub(t).normalize().perp(!c),l=r/(1+o.dot(u)),t.vadd(o.vadd(u).mult(l)),s.done(),t}}}),n.geometry("rectangle",function(e){var t={};return{init:function(n){var r=this;e.init.call(this,n),this.options.defaults(t),this.options.onChange(function(e){r.width=r.options.width||1,r.height=r.options.height||1}),this.options(n)},aabb:function(e){if(!e)return n.aabb(this.width,this.height);var t=n.scratchpad(),r=t.vector(),i=t.transform().setRotation(e||0),s=t.vector().set(1,0).rotateInv(i),o=t.vector().set(0,1).rotateInv(i),u=this.getFarthestHullPoint(s,r).proj(s),a=-this.getFarthestHullPoint(s.negate(),r).proj(s),f=this.getFarthestHullPoint(o,r).proj(o),l=-this.getFarthestHullPoint(o.negate(),r).proj(o);return t.done(),n.aabb(a,l,u,f)},getFarthestHullPoint:function(e,t){t=t||new n.vector;var r=e.x,i=e.y;return r=r===0?0:r<0?-this.width*.5:this.width*.5,i=i===0?0:i<0?-this.height*.5:this.height*.5,t.set(r,i)},getFarthestCorePoint:function(e,t,n){var r,i;return t=this.getFarthestHullPoint(e,t),r=t.x,i=t.y,t.x=r===0?0:r<0?r+n:r-n,t.y=i===0?0:i<0?i+n:i-n,t}}}),n.body("circle",function(e){var t={radius:1};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("circle",{radius:r.radius}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),n.body("convex-polygon",function(e){var t={};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("convex-polygon",{vertices:r.vertices}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=n.geometry.getPolygonMOI(this.geometry.vertices)}}}),n.body("rectangle",function(e){var t={};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("rectangle",{width:r.width,height:r.height}),this.recalc()},recalc:function(){var t=this.geometry.width,n=this.geometry.height;e.recalc.call(this),this.moi=(t*t+n*n)*this.mass/12}}}),n.behavior("attractor",function(e){var t={pos:null,strength:1,order:2,max:!1,min:!1};return{init:function(r){var i=this;this._pos=new n.vector,e.init.call(this),this.options.defaults(t),this.options.onChange(function(e){i._maxDist=e.max===!1?Infinity:e.max,i._minDist=e.min?e.min:10,i.position(e.pos)}),this.options(r)},position:function(e){var t=this;return e?(this._pos.clone(e),t):this._pos.values()},behave:function(e){var t=this.getTargets(),r,i=this.options.order,s=this.options.strength,o=this._minDist,u=this._maxDist,a=n.scratchpad(),f=a.vector(),l,c;for(var h=0,p=t.length;h<p;h++)r=t[h],f.clone(this._pos),f.vsub(r.state.pos),l=f.norm(),l>o&&l<u&&(c=s/Math.pow(l,i),r.accelerate(f.normalize().mult(c)));a.done()}}}),n.behavior("body-collision-detection",function(e){var t=[],r=function(r,i){var s=n.util.pairHash(r.uid,i.uid),o=t[s];return o||(o=t[s]=function(e){var t=n.scratchpad(),s=o.tA,u=o.tB,a=t.vector(),f=t.vector(),l=o.marginA,c=o.marginB;return o.useCore?(a=r.geometry.getFarthestCorePoint(e.rotateInv(s),a,l).transform(s),f=i.geometry.getFarthestCorePoint(e.rotate(s).rotateInv(u).negate(),f,c).transform(u)):(a=r.geometry.getFarthestHullPoint(e.rotateInv(s),a).transform(s),f=i.geometry.getFarthestHullPoint(e.rotate(s).rotateInv(u).negate(),f).transform(u)),e.negate().rotate(u),t.done({a:a.values(),b:f.values(),pt:a.vsub(f).values()})},o.tA=n.transform(),o.tB=n.transform()),o.useCore=!1,o.margin=0,o.tA.setTranslation(r.state.pos).setRotation(r.state.angular.pos),o.tB.setTranslation(i.state.pos).setRotation(i.state.angular.pos),o.bodyA=r,o.bodyB=i,o},i=function(t,i){var s=n.scratchpad(),o=s.vector(),u=s.vector(),a,f,l,c=!1,h=t.aabb(),p=Math.min(h.hw,h.hh),d=i.aabb(),v=Math.min(d.hw,d.hh);l=r(t,i),o.clone(t.state.pos).vsub(i.state.pos),f=n.gjk(l,o,!0);if(f.overlap){c={bodyA:t,bodyB:i},l.useCore=!0,l.marginA=0,l.marginB=0;while(f.overlap&&(l.marginA<p||l.marginB<v))l.marginA<p&&(l.marginA+=1),l.marginB<v&&(l.marginB+=1),f=n.gjk(l,o);if(f.overlap||f.maxIterationsReached)return s.done(!1);a=Math.max(0,l.marginA+l.marginB-f.distance),c.overlap=a,c.norm=o.clone(f.closest.b).vsub(u.clone(f.closest.a)).normalize().values(),c.mtv=o.mult(a).values(),c.pos=o.clone(c.norm).mult(l.margin).vadd(u.clone(f.closest.a)).vsub(t.state.pos).values()}return s.done(c)},s=function(t,r){var i=n.scratchpad(),s=i.vector(),o=i.vector(),u,a=!1;return s.clone(r.state.pos).vsub(t.state.pos),u=s.norm()-(t.geometry.radius+r.geometry.radius),s.equals(n.vector.zero)&&s.set(1,0),u<=0&&(a={bodyA:t,bodyB:r,norm:s.normalize().values(),mtv:s.mult(-u).values(),pos:s.normalize().mult(t.geometry.radius).values(),overlap:-u}),i.done(a)},o=function(t,n){return t.treatment!=="static"&&t.treatment!=="kinematic"||n.treatment!=="static"&&n.treatment!=="kinematic"?t.geometry.name==="circle"&&n.geometry.name==="circle"?s(t,n):i(t,n):!1},u={check:"collisions:candidates",channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(u),this.options(t)},connect:function(e){this.options.check===!0?e.on("integrate:velocities",this.checkAll,this):e.on(this.options.check,this.check,this)},disconnect:function(e){this.options.check===!0?e.off("integrate:velocities",this.checkAll):e.off(this.options.check,this.check)},check:function(e){var t=e.candidates,r,i=this.getTargets(),s=[],u;for(var a=0,f=t.length;a<f;++a){r=t[a];if(i===this._world._bodies||n.util.indexOf(i,r.bodyA)>-1&&n.util.indexOf(i,r.bodyB)>-1)u=o(r.bodyA,r.bodyB),u&&s.push(u)}s.length&&this._world.emit(this.options.channel,{collisions:s})},checkAll:function(e){var t=this.getTargets(),n=e.dt,r,i,s=[],u;for(var a=0,f=t.length;a<f;a++){r=t[a];for(var l=a+1;l<f;l++)i=t[l],u=o(r,i),u&&s.push(u)}s.length&&this._world.emit(this.options.channel,{collisions:s})}}}),n.behavior("body-impulse-response",function(e){var t={check:"collisions:detected"};return{init:function(n){e.init.call(this),this.options.defaults(t),this.options(n)},applyTo:!1,connect:function(e){e.on(this.options.check,this.respond,this)},disconnect:function(e){e.off(this.options.check,this.respond)},collideBodies:function(e,t,r,i,s,o){var u=e.treatment==="static"||e.treatment==="kinematic",a=t.treatment==="static"||t.treatment==="kinematic",f=n.scratchpad(),l=f.vector().clone(s);if(u&&a){f.done();return}u?t.state.pos.vadd(l):a?e.state.pos.vsub(l):(l.mult(.5),e.state.pos.vsub(l),t.state.pos.vadd(l));var c=u?0:1/e.moi,h=a?0:1/t.moi,p=u?0:1/e.mass,d=a?0:1/t.mass,v=o?0:e.restitution*t.restitution,m=e.cof*t.cof,g=f.vector().clone(r),y=f.vector().clone(g).perp(),b=f.vector().clone(i),w=f.vector().clone(i).vadd(e.state.pos).vsub(t.state.pos),E=f.vector(),S=e.state.angular.vel,x=t.state.angular.vel,T=f.vector().clone(t.state.vel).vadd(E.clone(w).perp().mult(x)).vsub(e.state.vel).vsub(E.clone(b).perp().mult(S)),N=b.proj(g),C=b.proj(y),k=w.proj(g),L=w.proj(y),A=T.proj(g),O=T.proj(y),M,_,D,P=!1;if(A>=0){f.done();return}c=c===Infinity?0:c,h=h===Infinity?0:h,M=-((1+v)*A)/(p+d+c*C*C+h*L*L),u?(t.state.vel.vadd(g.mult(M*d)),t.state.angular.vel-=M*h*L):a?(e.state.vel.vsub(g.mult(M*p)),e.state.angular.vel+=M*c*C):(t.state.vel.vadd(g.mult(M*d)),t.state.angular.vel-=M*h*L,e.state.vel.vsub(g.mult(p*t.mass)),e.state.angular.vel+=M*c*C),m&&O&&(D=O/(p+d+c*N*N+h*k*k),P?M=D:(_=O<0?-1:1,M*=_*m,M=_===1?Math.min(M,D):Math.max(M,D)),u?(t.state.vel.vsub(y.mult(M*d)),t.state.angular.vel-=M*h*k):a?(e.state.vel.vadd(y.mult(M*p)),e.state.angular.vel+=M*c*N):(t.state.vel.vsub(y.mult(M*d)),t.state.angular.vel-=M*h*k,e.state.vel.vadd(y.mult(p*t.mass)),e.state.angular.vel+=M*c*N)),f.done()},respond:function(e){var t=this,r,i=n.util.shuffle(e.collisions);for(var s=0,o=i.length;s<o;++s)r=i[s],t.collideBodies(r.bodyA,r.bodyB,r.norm,r.pos,r.mtv)}}}),n.behavior("constant-acceleration",function(e){var t={acc:{x:0,y:4e-4}};return{init:function(r){e.init.call(this),this.options.defaults(t),this.options(r),this._acc=n.vector(),this.setAcceleration(this.options.acc),delete this.options.acc},setAcceleration:function(e){return this._acc.clone(e),this},behave:function(e){var t=this.getTargets();for(var n=0,r=t.length;n<r;++n)t[n].accelerate(this._acc)}}}),n.behavior("edge-collision-detection",function(e){var t=function(t,r,i){var s,o=t.aabb(),u=n.scratchpad(),a=u.transform(),f=u.vector(),l=u.vector(),c=!1,h=[];return s=o.x+o.hw-r.max.x,s>=0&&(f.set(1,0).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:1,y:0},mtv:{x:s,y:0},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),s=o.y+o.hh-r.max.y,s>=0&&(f.set(0,1).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:0,y:1},mtv:{x:0,y:s},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),s=r.min.x-(o.x-o.hw),s>=0&&(f.set(-1,0).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:-1,y:0},mtv:{x:-s,y:0},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),s=r.min.y-(o.y-o.hh),s>=0&&(f.set(0,-1).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:0,y:-1},mtv:{x:0,y:-s},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),u.done(),h},r=function(n,r,i){return t(n,r,i)},i={aabb:null,restitution:.99,cof:1,channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(i),this.options(t),this.setAABB(this.options.aabb),this.restitution=this.options.restitution,this.body=n.body("point",{treatment:"static",restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(e){if(!e)throw"Error: aabb not set";return this._edges={min:{x:e.x-e.hw,y:e.y-e.hh},max:{x:e.x+e.hw,y:e.y+e.hh}},this},connect:function(e){e.on("integrate:velocities",this.checkAll,this)},disconnect:function(e){e.off("integrate:velocities",this.checkAll)},checkAll:function(e){var t=this.getTargets(),n=e.dt,i,s=[],o,u=this._edges,a=this.body;for(var f=0,l=t.length;f<l;f++)i=t[f],i.treatment==="dynamic"&&(o=r(i,u,a),o&&s.push.apply(s,o));s.length&&this._world.emit(this.options.channel,{collisions:s})}}}),n.behavior("interactive",function(e){if(!t)return{};var r={el:null,moveThrottle:10,minVel:{x:-5,y:-5},maxVel:{x:5,y:5}},i=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return{left:t,top:n}},s=function(e){var t=i(e.target),n=e.changedTouches&&e.changedTouches[0]||e,r=n.pageX-t.left,s=n.pageY-t.top;return{x:r,y:s}};return{init:function(i){var o=this,u,a;e.init.call(this),this.options.defaults(r),this.options(i),this.mousePos=new n.vector,this.mousePosOld=new n.vector,this.offset=new n.vector,this.el=typeof this.options.el=="string"?t.getElementById(this.options.el):this.options.el;if(!this.el)throw"No DOM element specified";var f=function(t){var r=s(t),i;o._world&&(i=o._world.findOne({$at:new n.vector(r.x,r.y)}),i?(u=i.treatment,i.treatment="kinematic",i.state.vel.zero(),i.state.angular.vel=0,o.body=i,o.mousePos.clone(r),o.offset.clone(r).vsub(i.state.pos),r.body=i,o._world.emit("interact:grab",r)):o._world.emit("interact:poke",r))},l=n.util.throttle(function(t){var r=s(t),i;o.body&&(a=n.util.ticker.now(),o.mousePosOld.clone(o.mousePos),o.mousePos.set(r.x,r.y),r.body=o.body),o._world.emit("interact:move",r)},o.options.moveThrottle),c=function(t){var r=s(t),i,f=Math.max(n.util.ticker.now()-a,o.options.moveThrottle);o.mousePos.set(r.x,r.y),o.body&&(o.body.treatment=u,o.body.state.vel.clone(o.mousePos).vsub(o.mousePosOld).mult(1/f),o.body.state.vel.clamp(o.options.minVel,o.options.maxVel),o.body=!1),o._world&&o._world.emit("interact:release",r)};this.el.addEventListener("mousedown",f),this.el.addEventListener("touchstart",f),this.el.addEventListener("mousemove",l),this.el.addEventListener("touchmove",l),this.el.addEventListener("mouseup",c),this.el.addEventListener("touchend",c)},connect:function(e){e.on("integrate:positions",this.behave,this)},disconnect:function(e){e.off("integrate:positions",this.behave)},behave:function(e){var t=this,n,r=Math.max(e.dt,t.options.moveThrottle);t.body&&(n=t.body.state,n.vel.clone(t.mousePos).vsub(t.offset).vsub(n.pos).mult(1/r))}}}),n.behavior("newtonian",function(e){var t={strength:1,max:!1,min:!1};return{init:function(n){var r=this;e.init.call(this),this.options.defaults(t),this.options.onChange(function(e){r._maxDistSq=e.max===!1?Infinity:e.max*e.max,r._minDistSq=e.min?e.min*e.min:100*e.strength}),this.options(n)},behave:function(e){var t=this.getTargets(),r,i,s=this.options.strength,o=this._minDistSq,u=this._maxDistSq,a=n.scratchpad(),f=a.vector(),l,c;for(var h=0,p=t.length;h<p;h++){r=t[h];for(var d=h+1;d<p;d++)i=t[d],f.clone(i.state.pos),f.vsub(r.state.pos),l=f.normSq(),l>o&&l<u&&(c=s/l,r.accelerate(f.normalize().mult(c*i.mass)),i.accelerate(f.mult(r.mass/i.mass).negate()))}a.done()}}}),n.behavior("sweep-prune",function(e){var t=1,r=function(){return t++},i={x:0,y:1},s=2,o=n.util.pairHash;return{init:function(t){e.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(t),this.encounters=[],this.candidates=[],this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists=[];for(var e=0;e<s;++e)this.intervalLists[e]=[]},connect:function(e){e.on("add:body",this.trackBody,this),e.on("remove:body",this.untrackBody,this),e.on("integrate:velocities",this.sweep,this);var t=e.getBodies();for(var n=0,r=t.length;n<r;++n)this.trackBody({body:t[n]})},disconnect:function(e){e.off("add:body",this.trackBody),e.off("remove:body",this.untrackBody),e.off("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var e,t,n,r,i,o,u,a,f;for(var l=0;l<s;++l){e=this.intervalLists[l],n=0,t=e.length,f=l;while(++n<t){i=e[n],o=i.val.get(f),r=n,u=e[r-1],a=u&&u.val.get(f);while(r>0&&(a>o||a===o&&u.type&&!i.type))e[r]=u,r--,u=e[r-1],a=u&&u.val.get(f);e[r]=i}}},getPair:function(e,t,n){var r=o(e.id,t.id);if(r===!1)return null;var i=this.pairs[r];if(!i){if(!n)return null;i=this.pairs[r]={bodyA:e.body,bodyB:t.body,flag:1}}return i},checkOverlaps:function(){var e,t,n,r,o,u,a,f,l,c,h=1<<i.z+1<<i.y+1<<i.x+1,p=this.encounters,d=0,v=this.candidates;p.length=v.length=0;for(var m=0;m<s;++m){e=m===0,u=this.intervalLists[m];for(f=0,a=u.length;f<a;f++){o=u[f],n=o.tracker;if(o.type){l=d;for(l=d-1;l>=0;l--)r=p[l],r===n?(l<d-1?p[l]=p.pop():p.pop(),d--):(c=this.getPair(n,r,e),c&&(c.flag>h&&(c.flag=1),c.flag=c.flag<<m+1,c.flag===h&&v.push(c)))}else d=p.push(n)}}return v},updateIntervals:function(){var e,t,r=n.scratchpad(),i=r.vector(),s,o=r.vector(),u=this.tracked,a=u.length;while(--a>=0)e=u[a],t=e.interval,i.clone(e.body.state.pos),s=e.body.aabb(),o.set(s.hw,s.hh),t.min.val.clone(i).vsub(o),t.max.val.clone(i).vadd(o);r.done()},trackBody:function(e){var t=e.body,i={id:r(),body:t},o={min:{type:!1,val:n.vector(),tracker:i},max:{type:!0,val:n.vector(),tracker:i}};i.interval=o,this.tracked.push(i);for(var u=0;u<s;++u)this.intervalLists[u].push(o.min,o.max)},untrackBody:function(e){var t=e.body,n,r,i=this.tracked,o,u;for(var a=0,f=i.length;a<f;++a){o=i[a];if(o.body===t){i.splice(a,1);for(var l=0;l<s;++l){u=0,n=this.intervalLists[l];for(var c=0,h=n.length;c<h;++c){r=n[c];if(r===o.interval.min||r===o.interval.max){n.splice(c,1),c--,f--;if(u>0)break;u++}}}break}}},sweep:function(e){var t=this,n;n=t.broadPhase(),n.length&&this._world.emit(this.options.channel,{candidates:n})}}}),n.behavior("verlet-constraints",function(e){var t=2*Math.PI,r={iterations:2};return{init:function(t){e.init.call(this),this.options.defaults(r),this.options(t),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(e){var t=e.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';e.on("integrate:positions",this.resolve,this)},disconnect:function(e){e.off("integrate:positions",this.resolve)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(e,t,r,i){var s;return!e||!t?!1:(s={id:n.util.uniqueId("dis-constraint"),type:"dis",bodyA:e,bodyB:t,stiffness:r||.5,targetLength:i||t.state.pos.dist(e.state.pos)},s.targetLengthSq=s.targetLength*s.targetLength,this._distanceConstraints.push(s),s)},angleConstraint:function(e,t,r,i,s){var o;return!e||!t?!1:(o={id:n.util.uniqueId("ang-constraint"),type:"ang",bodyA:e,bodyB:t,bodyC:r,stiffness:i||.5,targetAngle:s||t.state.pos.angle2(e.state.pos,r.state.pos)},this._angleConstraints.push(o),o)},remove:function(e){var t,r,i,s,o;i=n.util.isObject(e),r=i?e.type:e.substr(0,3),t=r==="ang"?this._angleConstraints:this._distanceConstraints;if(i){for(s=0,o=t.length;s<o;++s)if(t[s]===e)return t.splice(s,1),this}else for(s=0,o=t.length;s<o;++s)if(t[s].id===e)return t.splice(s,1),this;return this},resolveAngleConstraints:function(e){var r=this._angleConstraints,i=n.scratchpad(),s=i.transform(),o,u,a,f,l;for(var c=0,h=r.length;c<h;++c){o=r[c],u=o.bodyB.state.pos.angle2(o.bodyA.state.pos,o.bodyC.state.pos),a=u-o.targetAngle;if(!a)continue;a<=-Math.PI?a+=t:a>=Math.PI&&(a-=t),s.setTranslation(o.bodyB.state.pos),a*=-e*o.stiffness,o.bodyA.treatment==="dynamic"&&o.bodyB.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"&&(l=1/(o.bodyA.mass+o.bodyB.mass+o.bodyC.mass)),o.bodyA.treatment==="dynamic"&&(o.bodyB.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"?u=a*(o.bodyB.mass+o.bodyC.mass)*l:o.bodyB.treatment!=="dynamic"?u=a*o.bodyC.mass/(o.bodyC.mass+o.bodyA.mass):u=a*o.bodyB.mass/(o.bodyB.mass+o.bodyA.mass),s.setRotation(u),o.bodyA.state.pos.translateInv(s),o.bodyA.state.pos.rotate(s),o.bodyA.state.pos.translate(s)),o.bodyC.treatment==="dynamic"&&(o.bodyA.treatment==="dynamic"&&o.bodyB.treatment==="dynamic"?u=-a*(o.bodyB.mass+o.bodyA.mass)*l:o.bodyB.treatment!=="dynamic"?u=-a*o.bodyA.mass/(o.bodyC.mass+o.bodyA.mass):u=-a*o.bodyB.mass/(o.bodyB.mass+o.bodyC.mass),s.setRotation(u),o.bodyC.state.pos.translateInv(s),o.bodyC.state.pos.rotate(s),o.bodyC.state.pos.translate(s)),o.bodyB.treatment==="dynamic"&&(o.bodyA.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"?u=a*(o.bodyA.mass+o.bodyC.mass)*l:o.bodyA.treatment!=="dynamic"?u=a*o.bodyC.mass/(o.bodyC.mass+o.bodyB.mass):u=a*o.bodyA.mass/(o.bodyA.mass+o.bodyC.mass),s.setRotation(u).setTranslation(o.bodyA.state.pos),o.bodyB.state.pos.translateInv(s),o.bodyB.state.pos.rotate(s),o.bodyB.state.pos.translate(s),s.setTranslation(o.bodyC.state.pos),o.bodyB.state.pos.translateInv(s),o.bodyB.state.pos.rotateInv(s),o.bodyB.state.pos.translate(s))}i.done()},resolveDistanceConstraints:function(e){var t=this._distanceConstraints,r=n.scratchpad(),i=r.vector(),s,o,u,a;for(var f=0,l=t.length;f<l;++f)s=t[f],i.clone(s.bodyB.state.pos).vsub(s.bodyA.state.pos),o=i.normSq()||Math.random()*1e-4,u=e*s.stiffness*(o-s.targetLengthSq)/o,i.mult(u),a=s.bodyA.treatment!=="dynamic"||s.bodyB.treatment!=="dynamic"?1:s.bodyB.mass/(s.bodyA.mass+s.bodyB.mass),s.bodyA.treatment==="dynamic"&&(s.bodyB.treatment==="dynamic"&&i.mult(a),s.bodyA.state.pos.vadd(i),s.bodyB.treatment==="dynamic"&&i.mult(1/a)),s.bodyB.treatment==="dynamic"&&(s.bodyA.treatment==="dynamic"&&i.mult(1-a),s.bodyB.state.pos.vsub(i));r.done()},shuffleConstraints:function(){this._distanceConstraints=n.util.shuffle(this._distanceConstraints),this._angleConstraints=n.util.shuffle(this._angleConstraints)},resolve:function(){var e=this.options.iterations,t=1/e;for(var n=0;n<e;n++)this.resolveDistanceConstraints(t),this.resolveAngleConstraints(t)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),n.integrator("improved-euler",function(e){return{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){var n=1-this.options.drag,r=null,i;for(var s=0,o=e.length;s<o;++s)r=e[s],i=r.state,r.treatment!=="static"?(i.old.vel.clone(i.vel),i.old.acc.clone(i.acc),i.vel.vadd(i.acc.mult(t)),n&&i.vel.mult(n),i.acc.zero(),i.old.angular.vel=i.angular.vel,i.angular.vel+=i.angular.acc*t,i.angular.acc=0):(i.vel.zero(),i.acc.zero(),i.angular.vel=0,i.angular.acc=0)},integratePositions:function(e,t){var r=.5*t*t,i=null,s,o=n.scratchpad(),u=o.vector(),a;for(var f=0,l=e.length;f<l;++f)i=e[f],s=i.state,i.treatment!=="static"&&(s.old.pos.clone(s.pos),u.clone(s.old.vel),s.pos.vadd(u.mult(t)).vadd(s.old.acc.mult(r)),s.old.acc.zero(),s.old.angular.pos=s.angular.pos,s.angular.pos+=s.old.angular.vel*t+s.old.angular.acc*r,s.old.angular.acc=0);o.done()}}}),n.renderer("canvas",function(e){if(!t)return{};var r=Math.PI*2,i=function(e,n){var r=t.createElement(e||"div");return n&&(r.innerHTML=n),r},s={white:"#fff",violet:"#542437",blue:"#53777A"},o={debug:!1,metaEl:null,styles:{circle:{strokeStyle:s.blue,lineWidth:1,fillStyle:s.blue,angleIndicator:s.white},"convex-polygon":{strokeStyle:s.violet,lineWidth:1,fillStyle:s.violet,angleIndicator:s.white}},offset:{x:0,y:0}},u=function(e,t){return n.util.isPlainObject(t)?n.util.extend({},e,t,u):t!==undefined?t:e};return{init:function(r){var s=this;e.init.call(this,r),this.options=n.util.extend({},o,this.options,u),this.options.offset=n.vector(this.options.offset),this.hiddenCanvas=t.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100;if(!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var a=this.el;a.nodeName.toUpperCase()!=="CANVAS"&&(a=t.createElement("canvas"),this.el.appendChild(a),typeof this.options.el=="string"&&this.el===t.body&&(a.id=this.options.el),this.el=a),this.ctx=a.getContext("2d"),this.els={};if(this.options.meta){var f=this.options.metaEl||i();f.className="pjs-meta",this.els.fps=i("span"),this.els.ipf=i("span"),f.appendChild(i("span","fps: ")),f.appendChild(this.els.fps),f.appendChild(i("br")),f.appendChild(i("span","ipf: ")),f.appendChild(this.els.ipf),a.parentNode.insertBefore(f,a)}this._layers={},this.addLayer("main",this.el),this.resize(this.options.width,this.options.height)},layer:function(e){return e in this._layers?this._layers[e]:null},addLayer:function(e,r,i){var s=this,o=[],u=n.util.extend({},this.options.styles),a={id:e,el:r||t.createElement("canvas"),options:n.util.options({width:this.el.width,height:this.el.height,manual:!1,autoResize:!0,follow:null,offset:null,scale:1,zIndex:1})(i)};if(e in this._layers)throw'Layer "'+e+'" already added.';return this.el.parentNode.insertBefore(a.el,this.el),a.el.style.position="absolute",a.el.style.zIndex=a.options.zIndex,a.el.className+=" pjs-layer-"+a.id,a.ctx=a.el.getContext("2d"),a.ctx.scale(1,1),a.el.width=a.options.width,a.el.height=a.options.height,a.bodies=o,a.reset=function(e){return o=e||[],a},a.addToStack=function(e){return n.util.isArray(e)?o.push.apply(o,e):o.push(e),a},a.removeFromStack=function(e){var t,r;if(n.util.isArray(e))for(t=0,r=e.length;t<r;++t)a.removeFromStack(e[t]);else t=n.util.indexOf(o,e),t>-1&&o.splice(t,1);return a},a.render=function(e){var t,r=n.scratchpad(),i=r.vector().set(0,0),f=a.options.scale,l,c,h=o.length,p=h||a.id!=="main"?o:s._world._bodies;if(a.options.manual)return r.done(),a;a.options.offset&&(a.options.offset==="center"?i.add(a.el.width*.5,a.el.height*.5).mult(1/f):i.vadd(a.options.offset).mult(1/f)),a.options.follow&&i.vsub(a.options.follow.state.pos),e!==!1&&a.ctx.clearRect(0,0,a.el.width,a.el.height),f!==1&&(a.ctx.save(),a.ctx.scale(f,f));for(c=0,h=p.length;c<h;++c)t=p[c],t.hidden||(l=t.view||(t.view=s.createView(t.geometry,t.styles||u[t.geometry.name])),s.drawBody(t,t.view,a.ctx,i));return f!==1&&a.ctx.restore(),r.done(),a},this._layers[e]=a,a},removeLayer:function(e){var t=e.id?e.id:e,n=this._layers[t].el;return n!==this.el&&n.parentNode.removeChild(n),delete this._layers[t],this},resize:function(e,t){var n;for(var r in this._layers)n=this._layers[r],n.options.autoResize&&(n.el.width=e,n.el.height=t);return this},setStyle:function(e,t){t=t||this.ctx,n.util.isObject(e)?(e.strokeStyle=e.lineWidth?e.strokeStyle:"rgba(0,0,0,0)",n.util.extend(t,e)):(t.fillStyle=t.strokeStyle=e,t.lineWidth=1)},drawCircle:function(e,t,n,i,s){s=s||this.ctx,s.beginPath(),this.setStyle(i,s),s.arc(e,t,n,0,r,!1),s.closePath(),s.stroke(),s.fill()},drawPolygon:function(e,t,n){var r=e[0],i=r.x,s=r.y,o=e.length;n=n||this.ctx,n.beginPath(),this.setStyle(t,n),n.moveTo(i,s);for(var u=1;u<o;++u)r=e[u],i=r.x,s=r.y,n.lineTo(i,s);o>2&&n.closePath(),n.stroke(),n.fill()},drawRect:function(e,t,n,r,i,s){var o=n*.5,u=r*.5;s=s||this.ctx,this.setStyle(i,s),s.beginPath(),s.rect(e-o,t-u,n,r),s.closePath(),s.stroke(),s.fill()},drawLine:function(e,t,n,r){var i=e.x,s=e.y;r=r||this.ctx,r.beginPath(),this.setStyle(n,r),r.moveTo(i,s),i=t.x,s=t.y,r.lineTo(i,s),r.stroke(),r.fill()},createView:function(e,t){var n,r=e.aabb(),i=r.hw+Math.abs(r.x),s=r.hh+Math.abs(r.y),o=i+1,u=s+1,a=this.hiddenCtx,f=this.hiddenCanvas,l=e.name;return t=t||this.options.styles[l]||{},t.src?(n=new Image,n.src=t.src,t.width&&(n.width=t.width),t.height&&(n.height=t.height),n):(o+=t.lineWidth|0,u+=t.lineWidth|0,f.width=2*i+2+(2*t.lineWidth|0),f.height=2*s+2+(2*t.lineWidth|0),a.save(),a.translate(o,u),l==="circle"?this.drawCircle(0,0,e.radius,t,a):l==="convex-polygon"?this.drawPolygon(e.vertices,t,a):l==="rectangle"&&this.drawRect(0,0,e.width,e.height,t,a),t.angleIndicator&&(a.beginPath(),this.setStyle(t.angleIndicator,a),a.moveTo(0,0),a.lineTo(i,0),a.closePath(),a.stroke()),a.restore(),n=new Image(f.width,f.height),n.src=f.toDataURL("image/png"),n)},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:function(e,t,n,r){var i=e.state.pos,s=e.state.vel,o=this._interpolateTime||0,u,a,f,l;r=r||this.options.offset,n=n||this.ctx,u=i.x+r.x+s.x*o,a=i.y+r.y+s.y*o,f=e.state.angular.pos+e.state.angular.vel*o,n.save(),n.translate(u,a),n.rotate(f),n.drawImage(t,-t.width/2,-t.height/2),n.restore(),this.options.debug&&(l=e.aabb(),this.drawRect(l.x,l.y,2*l.hw,2*l.hh,"rgba(0, 0, 255, 0.3)"),e._debugView=e._debugView||this.createView(e.geometry,"rgba(255, 0, 0, 0.5)"),n.save(),n.translate(i.x+r.x,i.y+r.y),n.rotate(e.state.angular.pos),n.drawImage(e._debugView,-e._debugView.width*.5,-e._debugView.height*.5),n.restore())},render:function(e,t){var n,r,i;this._world.emit("beforeRender",{renderer:this,meta:t}),this.options.meta&&this.drawMeta(t),this._interpolateTime=t.interpolateTime;for(var s in this._layers)this._layers[s].render();return this}}}),n.renderer("dom",function(e){if(!t)return{};var n={},r=t.createElement("div"),i=function(t){return t.replace(/(?:^|\s)\w/g,function(e){return e.toUpperCase()})},s=function(t){if(n[t])return n[t];var s=["Webkit","Moz","Ms","O"],o;for(var u=0,a=s.length;u<a;++u){o=s[u]+i(t);if(o in r.style)return n[t]=o}return o in r.style?n[t]=t:!1},o="pjs-",u="px",a=s("transform"),f=function(e,n){var r=t.createElement(e||"div");return n&&(r.innerHTML=n),r},l;return{init:function(t){e.init.call(this,t);var n=this.el;n.style.position="relative",n.style.overflow="hidden",n.style[a]="translateZ(0)",n.style.width=this.options.width+u,n.style.height=this.options.height+u,this.els={};if(t.meta){var r=f();r.className="pjs-meta",this.els.fps=f("span"),this.els.ipf=f("span"),r.appendChild(f("span","fps: ")),r.appendChild(this.els.fps),r.appendChild(f("br")),r.appendChild(f("span","ipf: ")),r.appendChild(this.els.ipf),n.appendChild(r)}},circleProperties:function(e,t){var n=t.aabb();e.style.width=n.hw*2+u,e.style.height=n.hh*2+u,e.style.marginLeft=-n.hw+u,e.style.marginTop=-n.hh+u},rectangleProperties:function(e,t){var n=t.aabb();e.style.width=n.hw*2+u,e.style.height=n.hh*2+u,e.style.marginLeft=-n.hw+u,e.style.marginTop=-n.hh+u},createView:function(e){var t=f(),n=e.name+"Properties";return t.className=o+e.name,t.style.position="absolute",t.style.top="0px",t.style.left="0px",this[n]&&this[n](t,e),this.el.appendChild(t),t},connect:function(e){e.on("add:body",this.attach,this),e.on("remove:body",this.detach,this)},disconnect:function(e){e.off("add:body",this.attach),e.off("remove:body",this.detach)},detach:function(e){var t=e.nodeType&&e||e.body&&e.body.view,n=t&&t.parentNode;return t&&n&&n.removeChild(t),this},attach:function(e){var t=e.nodeType&&e||e.body&&e.body.view;return t&&this.el.appendChild(t),this},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:function(e,t){var n=e.state.pos,r=e.state.vel,i,s,o,u=this._interpolateTime;i=n.x+r.x*u,s=n.y+r.y*u,o=e.state.angular.pos+e.state.angular.vel*u,t.style[a]="translate("+i+"px,"+s+"px) rotate("+o+"rad)"}}}),n.renderer("pixi",function(e){if(!t)return{};var r=Math.PI*2,i={debug:!1,metaEl:null,offset:{x:0,y:0},styles:{color:"0x66FF99",point:"0xE8900C",circle:{strokeStyle:"0xE8900C",lineWidth:3,fillStyle:"0xD5DE4C",angleIndicator:"0xE8900C"},"convex-polygon":{strokeStyle:"0xE8900C",lineWidth:3,fillStyle:"0xD5DE4C",angleIndicator:"0xE8900C"}}},s=function(e,t){return n.util.isPlainObject(t)?n.util.extend({},e,t,s):t!==undefined?t:e};return{init:function(r){if(typeof PIXI=="undefined")throw"PIXI obj not present - cannot continue ";e.init.call(this,r),this.options=n.util.extend({},i,this.options,s),this.options.offset=n.vector(this.options.offset),this.stage=new PIXI.Stage(this.options.styles.color),this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height),this.meta={},this.el.nodeName==="CANVAS"?this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height,this.el):(this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height),this.el!==null?this.el.appendChild(this.renderer.view):t.body.appendChild(this.renderer.view))},loadSpriteSheets:function(e,t){if(!n.util.isArray(e))throw"Spritesheets must be defined in arrays";var r=this,i=new PIXI.AssetLoader(e);return i.load(),i.on("onComplete",function(e){r.assetsLoaded=!0,t()}),r},drawBody:function(e,t){var n=e.state.pos,r=e.state.vel,i=this._interpolateTime||0,s,o,u;s=n.x+r.x*i,o=n.y+r.y*i,u=e.state.angular.pos+e.state.angular.vel*i,t.position.x=s,t.position.y=o,t.rotation=u},render:function(t,n){e.render.call(this,t,n),this.renderer.render(this.stage)},createCircle:function(e,t,n,r){var i=new PIXI.Graphics;return i.beginFill(r.fillStyle),i.lineStyle(r.lineWidth,r.strokeStyle),i.drawCircle(e,t,n),i.pivot.x=e/2+n/2,i.pivot.y=t/2+n/2,i},createPolygon:function(e,t){var n=e[0],r=n.x,i=n.y,s=e.length,o={x:r,y:i},u=new PIXI.Graphics;u.beginFill(t.fillStyle),u.lineStyle(t.lineWidth,t.strokeStyle),u.moveTo(r,i);for(var a=1;a<s;++a)n=e[a],r=n.x,i=n.y,u.lineTo(r,i);return s>2&&u.lineTo(o.x,o.y),u.endFill(),u},createLine:function(e,t,n){var r=e.x,i=e.y,s=new PIXI.Graphics;return s.beginFill(n.fillStyle),s.lineStyle(n.lineWidth,n.strokeStyle),s.moveTo(r,i),r=t.x,i=t.y,s.lineTo(r,i),s.endFill(),s},createView:function(e){var t=null,n=e.aabb(),r=n.hw+Math.abs(n.x),i=n.hh+Math.abs(n.y),s=r+1,o=i+1,u=e.name,a=a||this.options.styles[u];s+=a.lineWidth|0,o+=a.lineWidth|0,u==="circle"?t=this.createCircle(s,o,e.radius,a):u==="convex-polygon"&&(t=this.createPolygon(e.vertices,a)),a.angleIndicator&&(t.beginFill(a.angleIndicator),t.moveTo(s/2,5+a.lineWidth),t.lineTo(s/2+e.radius/2,e.radius),t.endFill());if(t)return this.stage.addChild(t),t;throw"Invalid view name passed."},drawMeta:function(e){if(!this.meta.loaded){var t={font:"18px Snippet",fill:"white",align:"left"};this.meta.fps=new PIXI.Text("FPS: "+e.fps.toFixed(2),t),this.meta.fps.position.x=15,this.meta.fps.position.y=5,this.meta.ipf=new PIXI.Text("IPF: "+e.ipf,t),this.meta.ipf.position.x=15,this.meta.ipf.position.y=30,this.stage.addChild(this.meta.fps),this.stage.addChild(this.meta.ipf),this.meta.loaded=!0}else this.meta.fps.setText("FPS: "+e.fps.toFixed(2)),this.meta.ipf.setText("IPF: "+e.ipf)},createDisplay:function(e,t){var n=null,r=null;switch(e){case"sprite":return r=PIXI.Texture.fromImage(t.texture),n=new PIXI.Sprite(r),t.anchor&&(n.anchor.x=t.anchor.x,n.anchor.y=t.anchor.y),t.container?t.container.addChild(n):this.stage.addChild(n),n;case"movieclip":if(!this.assetsLoaded)throw"No assets have been loaded. Use loadSpritesheet() first";var i=[],s=0;for(s;s<t.frames.length;s++)r=PIXI.Texture.fromFrame(t.frames[s]),i.push(r);return n=new PIXI.MovieClip(i),t.anchor&&(n.anchor.x=t.anchor.x,n.anchor.y=t.anchor.y),t.container?t.container.addChild(n):this.stage.addChild(n),n;default:throw"Invalid PIXI.DisplayObject passed"}},centerAnchor:function(e){e!==null&&(e.anchor.x=.5,e.anchor.y=.5)}}}),n});