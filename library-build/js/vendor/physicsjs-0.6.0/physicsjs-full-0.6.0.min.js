/**
 * PhysicsJS v0.6.0 - 2014-04-22
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

!function(e,t){"object"==typeof exports?module.exports=t.call(e):"function"==typeof define&&define.amd?define([],function(){return t.call(e)}):e.Physics=t.call(e)}(this,function(){var e=this,t=e.document,n=function i(){return i.world.apply(i,arguments)};n.util={},function(){n.aabb=function(e,t,n,r){var i={x:0,y:0,hw:0,hh:0};return void 0===e?i:(e&&void 0!==e.x&&(n=t.x,r=t.y,t=e.y,e=e.x),void 0===r&&void 0!==e&&void 0!==t?(i.hw=.5*e,i.hh=.5*t,n&&void 0!==n.x&&(i.x=n.x,i.y=n.y),i):(i.hw=.5*Math.abs(n-e),i.hh=.5*Math.abs(r-t),i.x=.5*(n+e),i.y=.5*(r+t),i))},n.aabb.contains=function(e,t){return t.x>e.x-e.hw&&t.x<e.x+e.hw&&t.y>e.y-e.hh&&t.y<e.y+e.hh},n.aabb.clone=function(e){return{x:e.x,y:e.y,hw:e.hw,hh:e.hh}},n.aabb.overlap=function(e,t){var n=e.x-e.hw,r=t.x-t.hw,i=e.x+e.hw,s=t.x+t.hw;return i>=r&&s>=i||s>=n&&i>=s?(n=e.y-e.hh,r=t.y-t.hh,i=e.y+e.hh,s=t.y+t.hh,i>=r&&s>=i||s>=n&&i>=s):!1}}(),function(){var e=1e-4,t=100,r=function(e,t,n){var r=t.normSq()-t.dot(e),i=t.dot(e)-e.normSq();return 0>r?n.clone(t).negate():i>0?n.clone(e).negate():(n.clone(t).vsub(e),n.perp(e.cross(n)>0))},i=function(e){var t,r,i=e.length,s=e[i-2],o=e[i-3],u=n.scratchpad(),a=u.vector().clone(s.pt),f=u.vector().clone(o.pt).vsub(a);return f.equals(n.vector.zero)?u.done({a:s.a,b:s.b}):(t=-f.dot(a)/f.normSq(),r=1-t,0>=r?u.done({a:o.a,b:o.b}):0>=t?u.done({a:s.a,b:s.b}):u.done({a:a.clone(s.a).mult(r).vadd(f.clone(o.a).mult(t)).values(),b:a.clone(s.b).mult(r).vadd(f.clone(o.b).mult(t)).values()}))},s=function(s,o,u,f){var l,h,p,v,m=!1,g=!1,y=!1,w=[],E=1,S=n.scratchpad(),x=S.vector().clone(o||n.vector.axis[0]),T=S.vector(),N=S.vector(),C=S.vector(),k=S.vector(),L=0;for(v=s(x),E=w.push(v),T.clone(v.pt),x.negate();++L;){if(T.swap(N),v=s(x),E=w.push(v),T.clone(v.pt),f&&f(w),T.equals(n.vector.zero)){m=!0;break}if(!g&&T.dot(x)<=0){if(u)break;g=!0}if(2===E)x=r(T,N,x);else if(g){if(x.normalize(),v=N.dot(x),Math.abs(v-T.dot(x))<e){y=-v;break}N.normSq()<C.clone(w[0].pt).normSq()?w.shift():w.splice(1,1),x=r(C.clone(w[1].pt),k.clone(w[0].pt),x)}else if(l=l||S.vector(),h=h||S.vector(),l.clone(N).vsub(T),h.clone(w[0].pt).vsub(T),p=l.cross(h)>0,p^T.cross(l)>0)w.shift(),l.perp(!p),x.swap(l);else{if(!(p^h.cross(T)>0)){m=!0;break}w.splice(1,1),h.perp(p),x.swap(l)}if(L>t)return S.done(),{simplex:w,iterations:L,distance:0,maxIterationsReached:!0}}return S.done(),v={overlap:m,simplex:w,iterations:L},y!==!1&&(v.distance=y,v.closest=i(w)),v};n.gjk=s}(),function(){var e=function t(e,r,i){return this instanceof t?(this.v=n.vector(),this.o=n.vector(),e instanceof t?(this.clone(e),void 0):(e&&this.setTranslation(e),this.setRotation(r||0,i),void 0)):new t(e,r)};e.prototype.setTranslation=function(e){return this.v.clone(e),this},e.prototype.setRotation=function(e,t){return this.cosA=Math.cos(e),this.sinA=Math.sin(e),t?this.o.clone(t):this.o.zero(),this},e.prototype.clone=function(t){return t?(this.setTranslation(t.v),this.cosA=t.cosA,this.sinA=t.sinA,this.o.clone(t.o),this):new e(this)},n.transform=e}(),function(e){var t=Math.sqrt,r=Math.min,i=Math.max,s=(Math.acos,Math.atan2),o=2*Math.PI,u=!!e.Float64Array,a=function f(e,t){return this instanceof f?(this._=u?new Float64Array(5):[],e&&(void 0!==e.x||e._&&e._.length)?this.clone(e):(this.recalc=!0,this.set(e,t)),void 0):new f(e,t)};Object.defineProperties(a.prototype,{x:{get:function(){return+this._[0]},set:function(e){e=+e||0,this.recalc=e===this._[0],this._[0]=e}},y:{get:function(){return+this._[1]},set:function(e){e=+e||0,this.recalc=e===this._[1],this._[1]=e}}}),a.prototype.set=function(e,t){return this.recalc=!0,this._[0]=+e||0,this._[1]=+t||0,this},a.prototype.get=function(e){return this._[e]},a.prototype.vadd=function(e){return this.recalc=!0,this._[0]+=e._[0],this._[1]+=e._[1],this},a.prototype.vsub=function(e){return this.recalc=!0,this._[0]-=e._[0],this._[1]-=e._[1],this},a.prototype.add=function(e,t){return this.recalc=!0,this._[0]+=+e||0,this._[1]+=+t||0,this},a.prototype.sub=function(e,t){return this.recalc=!0,this._[0]-=e,this._[1]-=void 0===t?0:t,this},a.prototype.mult=function(e){return this.recalc||(this._[4]*=e*e,this._[3]*=e),this._[0]*=e,this._[1]*=e,this},a.prototype.dot=function(e){return this._[0]*e._[0]+this._[1]*e._[1]},a.prototype.cross=function(e){return-this._[0]*e._[1]+this._[1]*e._[0]},a.prototype.proj=function(e){return this.dot(e)/e.norm()},a.prototype.vproj=function(e){var t=this.dot(e)/e.normSq();return this.clone(e).mult(t)},a.prototype.angle=function(e){var t;if(this.equals(a.zero))return e?e.angle():0/0;for(t=e&&!e.equals(a.zero)?s(this._[1]*e._[0]-this._[0]*e._[1],this._[0]*e._[0]+this._[1]*e._[1]):s(this._[1],this._[0]);t>Math.PI;)t-=o;for(;t<-Math.PI;)t+=o;return t},a.prototype.angle2=function(e,t){for(var n=e._[0]-this._[0],r=e._[1]-this._[1],i=t._[0]-this._[0],u=t._[1]-this._[1],a=s(r*i-n*u,n*i+r*u);a>Math.PI;)a-=o;for(;a<-Math.PI;)a+=o;return a},a.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[3]},a.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[4]},a.prototype.dist=function(e){var n,r;return t((n=e._[0]-this._[0])*n+(r=e._[1]-this._[1])*r)},a.prototype.distSq=function(e){var t,n;return(t=e._[0]-this._[0])*t+(n=e._[1]-this._[1])*n},a.prototype.perp=function(e){var t=this._[0];return e?(this._[0]=this._[1],this._[1]=-t):(this._[0]=-this._[1],this._[1]=t),this},a.prototype.normalize=function(){var e=this.norm();return 0===e?this:(e=1/e,this._[0]*=e,this._[1]*=e,this._[3]=1,this._[4]=1,this)},a.prototype.transform=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r,this._[1]-=i,this.set(this._[0]*n-this._[1]*t+r+e.v._[0],this._[0]*t+this._[1]*n+i+e.v._[1])},a.prototype.transformInv=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r+e.v._[0],this._[1]-=i+e.v._[1],this.set(this._[0]*n+this._[1]*t+r,-this._[0]*t+this._[1]*n+i)},a.prototype.rotate=function(e,t){var n,r,i=0,s=0;return"number"==typeof e?(n=Math.sin(e),r=Math.cos(e),t&&(i=0|(t.x||t._[0]),s=0|(t.y||t._[1]))):(n=e.sinA,r=e.cosA,i=e.o._[0],s=e.o._[1]),this._[0]-=i,this._[1]-=s,this.set(this._[0]*r-this._[1]*n+i,this._[0]*n+this._[1]*r+s)},a.prototype.rotateInv=function(e){return this.set((this._[0]-e.o._[0])*e.cosA+(this._[1]-e.o._[1])*e.sinA+e.o._[0],-(this._[0]-e.o._[0])*e.sinA+(this._[1]-e.o._[1])*e.cosA+e.o._[1])},a.prototype.translate=function(e){return this.vadd(e.v)},a.prototype.translateInv=function(e){return this.vsub(e.v)},a.prototype.clone=function(e){return e?e._?(this.recalc=e.recalc,e.recalc||(this._[3]=e._[3],this._[4]=e._[4]),this._[0]=e._[0],this._[1]=e._[1],this):this.set(e.x,e.y):new a(this)},a.prototype.swap=function(e){var t=this._;return this._=e._,e._=t,t=this.recalc,this.recalc=e.recalc,e.recalc=t,this},a.prototype.values=function(){return{x:this._[0],y:this._[1]}},a.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},a.prototype.negate=function(e){return void 0!==e?(this._[e]=-this._[e],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},a.prototype.clamp=function(e,t){return this._[0]=r(i(this._[0],e.x),t.x),this._[1]=r(i(this._[1],e.y),t.y),this.recalc=!0,this},a.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},a.prototype.equals=function(e){return this._[0]===e._[0]&&this._[1]===e._[1]&&this._[2]===e._[2]},a.axis=[new a(1,0),new a(0,1)],a.zero=new a(0,0),n.vector=a}(this),function(e){var t=e.Physics;n.noConflict=function(){return e.Physics===n&&(e.Physics=t),n}}(this);var r=n.util.decorator=function(e,t){var r={},i={},s=function(e,t){var r,i;for(i in t)r=Object.getOwnPropertyDescriptor(t,i),r.get||r.set?Object.defineProperty(e,i,r):n.util.isFunction(r.value)&&(e[i]=r.value);return e},o=Object.getPrototypeOf;"function"!=typeof o&&(o="object"==typeof "test".__proto__?function(e){return e.__proto__}:function(e){return e.constructor.prototype});var u=Object.create;"function"!=typeof u&&(u=function(e){function t(){}return t.prototype=e,new t});var a=function(t,r){return"object"==typeof t?(i=s(i,t),i.type=e,void 0):("type"!==t&&n.util.isFunction(r)&&(i[t]=r),void 0)};a(t);var f=function(t,n,a,f){var l,c=i;if("string"!=typeof n)f=a,a=n;else{if(c=r[n],!c)throw'Error: "'+n+'" '+e+" not defined";c=c.prototype}if("function"==typeof a)l=r[t],l?l.prototype=s(l.prototype,a(o(l.prototype))):(l=r[t]=function(e){this.init&&this.init(e)},l.prototype=u(c),l.prototype=s(l.prototype,a(c,l.prototype))),l.prototype.type=e,l.prototype.name=t;else if(f=a||{},l=r[t],!l)throw'Error: "'+t+'" '+e+" not defined";return f?new l(f):void 0};return f.mixin=a,f};return n.util.indexOf=function(e,t){for(var n=0,r=e.length;r>n;){if(r--,e[n]===t)return n;if(e[r]===t)return r;n++}return-1},n.util.throttle=function(e,t,n){var r,i,s=!1,o=function(){clearTimeout(r),s?(s=!1,r=setTimeout(o,t),e.apply(n,i)):r=!1};return n=n||null,function(){s=!0,i=arguments,r||o()}},n.util.options=function(e,t){var r,i={},s=[];return r=function(e){n.util.extend(t,e,null);for(var r=0,i=s.length;i>r;++r)s[r](t);return t},r.defaults=function(e){return n.util.extend(i,e),n.util.defaults(t,i),i},r.onChange=function(e){s.push(e)},t=t||r,r.defaults(e),r},n.util.pairHash=function(e,t){return e=0|e,t=0|t,(0|e)===(0|t)?-1:0|((0|e)>(0|t)?e<<16|65535&t:t<<16|65535&e)},n.util.bind=Function.prototype.bind?function(e,t,n){return n=Array.prototype.slice.call(arguments,1),Function.prototype.bind.apply(e,n)}:function(e,t,n){return n=Array.prototype.slice.call(arguments,2),function(){return e.apply(t,n.concat(Array.prototype.slice.call(arguments)))}},n.util.find=function(e,t){var n,r,i=e.length;for(n=0;i>n;n++)if(r=e[n],t(r,n,e))return r},n.util.filter=function(e,t){var n,r,i=e.length,s=[];for(n=0;i>n;n++)r=e[n],t(r,n,e)&&s.push(r);return s},function(){function e(e){e.length=0,S.length<T&&S.push(e)}function t(e){var n=e.cache;n&&t(n),e.array=e.cache=e.criteria=e.object=e.number=e.string=e.value=null,x.length<T&&x.push(e)}function r(){return x.pop()||{array:null,cache:null,criteria:null,"false":!1,index:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,"undefined":!1,value:null}}function i(){return S.pop()||[]}function s(e,t){var r=typeof t;if(e=e.cache,"boolean"===r||null==t)return e[t]?0:-1;"number"!==r&&"string"!==r&&(r="object");var i="number"===r?t:N+t;return e=(e=e[r])&&e[i],"object"===r?e&&n.util.indexOf(e,t)>-1?0:-1:e?0:-1}function o(e){var t=this.cache,n=typeof e;if("boolean"===n||null==e)t[e]=!0;else{"number"!==n&&"string"!==n&&(n="object");var r="number"===n?e:N+e,i=t[n]||(t[n]={});"object"===n?(i[r]||(i[r]=[])).push(e):i[r]=!0}}function u(e){var t=-1,n=e.length,i=e[0],s=e[0|n/2],u=e[n-1];if(i&&"object"==typeof i&&s&&"object"==typeof s&&u&&"object"==typeof u)return!1;var a=r();a["false"]=a["null"]=a["true"]=a.undefined=!1;var f=r();for(f.array=e,f.cache=a,f.push=o;++t<n;)f.push(e[t]);return f}function a(e,t){return e+Math.floor(Math.random()*(t-e+1))}function f(e){return"function"==typeof e}function l(e){return"function"==typeof e&&A.test(e)}function h(e){var t,n;if(!!e&&b.call(e)===g&&(t=e.constructor,!f(t)||t instanceof t)){for(var r in e)n=r;return"undefined"==typeof n||w.call(e,n)}return!1}function p(r,o,a){var f=-1,l=n.util.indexOf,h=r?r.length:0,p=[],d=!o&&h>=E&&l===n.util.indexOf,v=a||d?i():p;if(d){var m=u(v);l=s,v=m}for(;++f<h;){var g=r[f],y=a?a(g,f,r):g;(o?!f||v[v.length-1]!==y:l(v,y)<0)&&((a||d)&&v.push(y),p.push(g))}return d?(e(v.array),t(v)):a&&e(v),p}var d={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},v=function(e){return e},m="[object Array]",g="[object Object]",y=Object.keys,b=Object.prototype.toString,w=Object.prototype.hasOwnProperty,E=75,S=[],x=[],T=40,N=+(new Date)+"",C=function(e){var t,n=e,r=[];if(!n)return r;if(!d[typeof e])return r;for(t in n)w.call(n,t)&&r.push(t);return r},k=y?function(e){return n.util.isObject(e)?y(e):[]}:C,L=0;n.util.uniqueId=function(e){var t=++L;return""+(e||"")+t},n.util.shuffle=function(e){var t,n,r,i,s=-1,o=e?e.length:0,u=Array("number"==typeof o?o:0);for(t=0,n=e.length;n>t;t++)r=e[t],i=a(0,++s),u[s]=u[i],u[i]=r;return u},n.util.isObject=function(e){return!!e&&!!d[typeof e]},n.util.isFunction=f,n.util.isArray=Array.isArray||function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&b.call(e)===m||!1};var A=RegExp("^"+String(b).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");n.util.isPlainObject=Object.getPrototypeOf?function(e){if(!e||b.call(e)!==g)return!1;var t=e.valueOf,n=l(t)&&(n=Object.getPrototypeOf(t))&&Object.getPrototypeOf(n);return n?e===n||Object.getPrototypeOf(e)===n:h(e)}:h,n.util.uniq=function(e,t,n){return"boolean"!=typeof t&&null!=t&&(n=t,t=!1),p(e,t,n)};var O=function(e,t,n){var r,i=e,s=i;if(!i)return s;var o,u=arguments,a=0,f="number"==typeof n?2:u.length;for(f>2&&"function"==typeof u[f-1]&&(o=u[--f]);++a<f;)if(i=u[a],i&&d[typeof i])for(var l=-1,c=d[typeof i]&&k(i),h=c?c.length:0;++l<h;)r=c[l],s[r]=o?o(s[r],i[r]):i[r];return s};n.util.extend=O,n.util.defaults=function(e,t,n){var r,i=e,s=i;if(!i)return s;for(var o=arguments,u=0,a="number"==typeof n?2:o.length;++u<a;)if(i=o[u],i&&d[typeof i])for(var f=-1,l=d[typeof i]&&k(i),c=l?l.length:0;++f<c;)r=l[f],"undefined"==typeof s[r]&&(s[r]=i[r]);return s},n.util.sortedIndex=function(e,t,n){var r=0,i=e?e.length:r;for(n=n||v,t=n(t);i>r;){var s=r+i>>>1;n(e[s])<t?r=s+1:i=s}return r}}(),n.scratchpad=function(){var e,t,r="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",i="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",s="Error: Too many scratchpads created. (Did you forget to call .done()?)",o="Error: Object is already registered.",u=[],a=0,f=0;return e=function(){if(this._active=!1,this._indexArr=[],++a>=t.maxScratches)throw s},e.prototype={done:function(e){this._active=!1;for(var t=0;f>t;++t)this[t]=0;return u.push(this),e}},t=function l(t){if(t)return l.fn(t);var n=u.pop()||new e;return n._active=!0,n},t.maxScratches=100,t.maxIndex=20,t.fn=function(t){for(var n=[],r=0,i=t.length;i>r;r++)n.push(r);n="a"+n.join(",a");var s=new Function("fn, scratches, Scratch","return function("+n+"){ "+"var scratch = scratches.pop() || new Scratch( scratches );"+"scratch._active = true;"+"return scratch.done( fn(scratch, "+n+") );"+"};");return s(t,u,e)},t.register=function(n,s,u){var a=e.prototype,l=f++,c="_"+n+"Stack",h=u&&u.useFactory;if(n in a)throw o;a[n]=function(){var e=this[c]||(this[c]=[]),n=0|this[l];if(this[l]=n+1,!this._active)throw r;if(n>=t.maxIndex)throw i;return e[n]||(e[n]=h?s():new s)}},t.register("vector",n.vector),t.register("transform",n.transform),t}(),function(){function e(e){return e._priority_}n.scratchpad.register("event",function(){return{}},{useFactory:!0});var t=function r(){return this instanceof r?void 0:new r};t.prototype={on:function(t,r,i,s){var o,u,f;if(this._topics=this._topics||(this._topics={}),n.util.isObject(t)){for(var l in t)this.on(l,t[l],r,i);return this}return o=this._topics[t]||(this._topics[t]=[]),u=r,n.util.isObject(i)?(r=n.util.bind(r,i),r._bindfn_=u,r._one_=u._one_):s||(s=i),r._priority_=s,f=n.util.sortedIndex(o,r,e),o.splice(f,0,r),this},off:function(e,t){var r,i;if(!this._topics)return this;if(e===!0)return this._topics={},this;if(n.util.isObject(e)){for(var s in e)this.off(s,e[s]);return this}if(r=this._topics[e],!r)return this;if(t===!0)return this._topics[e]=[],this;for(var o=0,u=r.length;u>o;o++)if(i=r[o],i._bindfn_===t||i===t){r.splice(o,1);break}return this},emit:function(e,t){if(!this._topics)return this;var r,i,s=this._topics[e],o=s&&s.length,u=n.scratchpad();if(!o)return u.done(this);for(i=u.event(),i.topic=e,i.handler=r;o--;)r=s[o],r(t,i),r._one_&&s.splice(o,1);return u.done(this)},one:function(e,t,r){if(n.util.isObject(e)){for(var i in e)this.one(i,e[i],t,r);return this}return t._one_=!0,this.on(e,t,r),this}},n.util.pubsub=t}(),function(e){function t(){return h&&h.now?h.now()+h.timing.navigationStart:Date.now()}function r(){var n;f&&(n=t(),n&&(e.requestAnimationFrame(r),l.emit("tick",n)))}function i(){return f=!0,r(),this}function s(){return f=!1,this}function o(e){return l.on("tick",e),this}function u(e){return l.off("tick",e),this}function a(){return!!f}var f=!1,l=n.util.pubsub(),h=e.performance;n.util.ticker={now:t,start:i,stop:s,on:o,off:u,isActive:a}}(this),function(){var e=function(){return!0},t=n.util.indexOf,r=function(e,t){return function(n){return e(n[t])}},i=function(e,r){return function(i){i=r?i[r]:i;var s,o=0;if(n.util.isArray(i)){if(n.util.isArray(e)){if(s=i.length,s!==e.length)return!1;for(;s>o;){if(s--,-1===t(e,i[o])||-1===t(e,i[s]))return!1;o++}return!0}return t(i,e)>-1}return i===e}},s=function(e,t){var n=i(e,t);return function(e){return!n(e)}},o=function(e,r){return function(i){i=r?i[r]:i;var s,o=0;if(n.util.isArray(i)){for(s=i.length;s>o;){if(s--,t(e,i[o])>-1||t(e,i[s])>-1)return!0;o++}return!1}return t(e,i)>-1}},u=function(e,t){var n=o(e,t);return function(e){return!n(e)}},a=function(e){return e=n.vector(e),function(t){var r=t.aabb();return n.aabb.contains(r,e)}},f=function(e){return e.next?function(t){for(var n=e;n;){if(!n(t))return!1;n=n.next}return!0}:e},l=function(e){return e.next?function(t){for(var n=e;n;){if(n(t))return!0;n=n.next}return!1}:e},h={$eq:i,$ne:s,$in:o,$nin:u,$at:a},p=function d(t,s){var o,u,a,p,v,m;if(s){if("$or"===s||"$and"===s){for(o=0,u=t.length;u>o;++o)m=d(t[o]),v=v?v.next=m:p=m;return"$or"===s?l(p):f(p)}if(o=h[s])return o(t);throw"Unknown query operation: "+s}for(o in t)a=t[o],m="$"===o[0]?d(a,o):n.util.isPlainObject(a)?r(d(a),o):i(a,o),v=v?v.next=m:p=m;return f(p||e)};n.query=p}(this),function(){var e={priority:0};n.behavior=r("behavior",{init:function(t){this.options=n.util.options(e),this.options(t)},applyTo:function(e){return this._targets=e===!0?null:n.util.uniq(e),this},getTargets:function(){return this._targets||(this._world?this._world._bodies:[])},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},connect:function(e){this.behave&&e.on("integrate:positions",this.behave,this,this.options.priority)},disconnect:function(e){this.behave&&e.off("integrate:positions",this.behave)},behave:null})}(),function(){var e={hidden:!1,treatment:"dynamic",mass:1,restitution:1,cof:.8,view:null},t=1;n.body=r("body",{init:function(r){var i=n.vector;if(this.options=n.util.options(e,this),this.options(r),this.state={pos:i(this.x,this.y),vel:i(this.vx,this.vy),acc:i(),angular:{pos:this.angle||0,vel:this.angularVelocity||0,acc:0},old:{pos:i(),vel:i(),acc:i(),angular:{pos:0,vel:0,acc:0}}},delete this.x,delete this.y,delete this.vx,delete this.vy,delete this.angle,delete this.angularVelocity,0===this.mass)throw"Error: Bodies must have non-zero mass";this.uid=t++,this.geometry=n.geometry("point")},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},accelerate:function(e){return"dynamic"===this.treatment&&this.state.acc.vadd(e),this},applyForce:function(e,t){if("dynamic"!==this.treatment)return this;var r,i=n.scratchpad(),s=i.vector();return t&&this.moi&&(r=this.state,s.clone(t),this.state.angular.acc-=s.cross(e)/this.moi),this.accelerate(s.clone(e).mult(1/this.mass)),i.done(),this},aabb:function(){var e=this.state.angular.pos,t=this.geometry.aabb(e);return t.x+=this.state.pos.x,t.y+=this.state.pos.y,t},recalc:function(){return this}})}(),function(){n.geometry=r("geometry",{init:function(e){this.options=n.util.options(),this.options(e),this._aabb=new n.aabb},aabb:function(){return n.aabb.clone(this._aabb)},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.set(0,0)},getFarthestCorePoint:function(e,t){return t=t||n.vector(),t.set(0,0)}})}(),n.geometry.isPolygonConvex=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=t.vector(),o=!0,u=!1,a=e.length;if(!e||!a)return!1;if(3>a)return t.done(),o;r.clone(e[0]).vsub(s.clone(e[a-1]));for(var f=1;a>=f;++f){if(i.clone(e[f%a]).vsub(s.clone(e[(f-1)%a])),u===!1)u=r.cross(i);else if(u>0^r.cross(i)>0){o=!1;break}i.swap(r)}return t.done(),o},n.geometry.getPolygonMOI=function(e){var t,r=n.scratchpad(),i=r.vector(),s=r.vector(),o=0,u=0,a=e.length;if(2>a)return r.done(),0;if(2===a)return t=s.clone(e[1]).distSq(i.clone(e[0])),r.done(),t/12;i.clone(e[0]);for(var f=1;a>f;++f)s.clone(e[f]),t=Math.abs(s.cross(i)),o+=t*(s.normSq()+s.dot(i)+i.normSq()),u+=t,i.swap(s);return r.done(),o/(6*u)},n.geometry.isPointInPolygon=function(e,t){var r=n.scratchpad(),i=r.vector().clone(e),s=r.vector(),o=r.vector(),u=0,a=t.length;if(2>a)return u=i.equals(s.clone(t[0])),r.done(),u;if(2===a)return u=i.angle(s.clone(t[0])),u+=i.angle(s.clone(t[1])),r.done(),Math.abs(u)===Math.PI;s.clone(t[0]).vsub(i);for(var f=1;a>=f;++f)o.clone(t[f%a]).vsub(i),u+=o.angle(s),s.swap(o);return r.done(),Math.abs(u)>1e-6},n.geometry.getPolygonArea=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=0,o=e.length;if(3>o)return t.done(),0;r.clone(e[o-1]);for(var u=0;o>u;++u)i.clone(e[u]),s+=r.cross(i),r.swap(i);return t.done(),s/2},n.geometry.getPolygonCentroid=function(e){var t,r=n.scratchpad(),i=r.vector(),s=r.vector(),o=n.vector(),u=e.length;if(2>u)return r.done(),n.vector(e[0]);if(2===u)return r.done(),n.vector((e[1].x+e[0].x)/2,(e[1].y+e[0].y)/2);i.clone(e[u-1]);for(var a=0;u>a;++a)s.clone(e[a]),t=i.cross(s),i.vadd(s).mult(t),o.vadd(i),i.swap(s);return t=1/(6*n.geometry.getPolygonArea(e)),r.done(),o.mult(t)},n.geometry.nearestPointOnLine=function(e,t,r){var i,s,o=n.scratchpad(),u=o.vector().clone(e),a=o.vector().clone(t).vsub(u),f=o.vector().clone(r).vsub(u).vsub(a);return f.equals(n.vector.zero)?(o.done(),n.vector(t)):(i=-f.dot(a)/f.normSq(),s=1-i,0>=s?(o.done(),n.vector(r)):0>=i?(o.done(),n.vector(t)):(u=n.vector(r).mult(i).vadd(a.clone(t).mult(s)),o.done(),u))},function(){var e={drag:0};n.integrator=r("integrator",{init:function(){this.options=n.util.options(e)},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},integrate:function(e,t){var n=this._world;return this.integrateVelocities(e,t),n&&n.emit("integrate:velocities",{bodies:e,dt:t}),this.integratePositions(e,t),n&&n.emit("integrate:positions",{bodies:e,dt:t}),this},connect:null,disconnect:null,integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var e={meta:!1,metaRefresh:200,width:600,height:600};n.renderer=r("renderer",{init:function(r){var i="string"==typeof r.el?t.getElementById(r.el):r.el;this.options=n.util.extend({},e,r),this.el=i?i:t.body,this.drawMeta=n.util.throttle(n.util.bind(this.drawMeta,this),this.options.metaRefresh)},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},render:function(e,t){var n,r;this.beforeRender&&this.beforeRender(),this._world.emit("beforeRender",{renderer:this,bodies:e,meta:t}),this.options.meta&&this.drawMeta(t),this._interpolateTime=t.interpolateTime;for(var i=0,s=e.length;s>i;++i)n=e[i],r=n.view||(n.view=this.createView(n.geometry,n.styles)),n.hidden||this.drawBody(n,r);return this},createView:function(){throw"You must override the renderer.createView() method."},drawMeta:function(){throw"You must override the renderer.drawMeta() method."},drawBody:function(){throw"You must override the renderer.drawBody() method."}})}(),function(){var e=function i(e,t,n){for(var r,s,o=function(){return i(e,t,n)};r=e.shift();)if(s=r.apply(t,n),s&&s.then)return s.then(o)},t={timestep:1e3/120,maxIPF:16,webworker:!1,integrator:"verlet"},r=function s(e,t){return this instanceof s?(this.init(e,t),void 0):new s(e,t)};r.prototype=n.util.extend({},n.util.pubsub.prototype,{init:function(r,i){var s=this;(n.util.isFunction(r)||n.util.isArray(r))&&(i=r,r={}),this._meta={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._warp=1,this._time=0,this.options=n.util.options(t),this.options.onChange(function(e){s.timestep(e.timestep)}),this.options(r),this.add(n.integrator(this.options.integrator)),n.util.isFunction(i)?e([i],this,[this,n]):n.util.isArray(i)&&e(i,this,[this,n])},options:null,add:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.addBehavior(r);break;case"integrator":this.integrator(r);break;case"renderer":this.renderer(r);break;case"body":this.addBody(r);break;default:throw'Error: failed to add item of unknown type "'+r.type+'" to world'}while(++t<n&&(r=e[t]));return this},remove:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.removeBehavior(r);break;case"integrator":r===this._integrator&&this.integrator(null);break;case"renderer":r===this._renderer&&this.renderer(null);break;case"body":this.removeBody(r);break;default:throw'Error: failed to remove item of unknown type "'+r.type+'" from world'}while(++t<n&&(r=e[t]));return this},has:function(e){var t;if(!e)return!1;switch(e.type){case"behavior":t=this._behaviors;break;case"integrator":return this._integrator===e;case"renderer":return this._renderer===e;case"body":t=this._bodies;break;default:throw'Error: unknown type "'+e.type+'"'}return n.util.indexOf(t,e)>-1},integrator:function(e){return void 0===e?this._integrator:this._integrator===e?this:(this._integrator&&(this._integrator.setWorld(null),this.emit("remove:integrator",{integrator:this._integrator})),e&&(this._integrator=e,this._integrator.setWorld(this),this.emit("add:integrator",{integrator:this._integrator})),this)},renderer:function(e){return void 0===e?this._renderer:this._renderer===e?this:(this._renderer&&(this._renderer.setWorld(null),this.emit("remove:renderer",{renderer:this._renderer})),e&&(this._renderer=e,this._renderer.setWorld(this),this.emit("add:renderer",{renderer:this._renderer})),this)},timestep:function(e){return e?(this._dt=e,this._maxJump=e*this.options.maxIPF,this):this._dt},addBehavior:function(e){return this.has(e)?this:(e.setWorld(this),this._behaviors.push(e),this.emit("add:behavior",{behavior:e}),this)},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(e){var t=this._behaviors;if(e)for(var n=0,r=t.length;r>n;++n)if(e===t[n]){t.splice(n,1),e.setWorld(null),this.emit("remove:behavior",{behavior:e});break}return this},addBody:function(e){return this.has(e)?this:(e.setWorld(this),this._bodies.push(e),this.emit("add:body",{body:e}),this)},getBodies:function(){return[].concat(this._bodies)},removeBody:function(e){var t=this._bodies;if(e)for(var n=0,r=t.length;r>n;++n)if(e===t[n]){t.splice(n,1),e.setWorld(null),this.emit("remove:body",{body:e});break}return this},findOne:function(e){var t=this,r="function"==typeof e?e:n.query(e);return n.util.find(t._bodies,r)||!1},find:function(e){var t=this,r="function"==typeof e?e:n.query(e);return n.util.filter(t._bodies,r)},iterate:function(e){this._integrator.integrate(this._bodies,e)},step:function(e){var t,r,i,s=this._time,o=this._warp,u=1/o,a=this._dt,f=a*u,l=this._maxJump*u,h=this._meta;if(this._paused||void 0===this._animTime)return this._animTime=e||this._animTime||n.util.ticker.now(),this._paused||this.emit("step",h),this;if(e=e||this._animTime+f,t=e-this._animTime,t>l&&(this._animTime=e-l,t=l),r=t*o,i=s+r-a,i>=s)for(;i>=s;)s+=a,this._animTime+=f,this._time=s,this.iterate(a);return h.fps=1e3/(e-this._lastTime),h.ipf=(r/a).toFixed(2),h.interpolateTime=a+i-s,this._lastTime=e,this.emit("step",h),this},warp:function(e){return void 0===e?this._warp:(this._warp=e||1,this)},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._meta),this.emit("render",{bodies:this._bodies,meta:this._meta,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.emit("pause"),this},unpause:function(){return this._paused=!1,this.emit("unpause"),this},isPaused:function(){return!!this._paused},destroy:function(){var e=this;e.pause(),this.emit("destroy"),e.off(!0),e.remove(e.getBodies()),e.remove(e.getBehaviors()),e.integrator(null),e.renderer(null)}}),n.world=r}(),n.integrator("verlet",function(e){return n.body.mixin({started:function(e){return void 0!==e&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){for(var n,r=t*t,i=1-this.options.drag,s=null,o=0,u=e.length;u>o;++o)s=e[o],n=s.state,"static"!==s.treatment?(n.vel.equals(n.old.vel)&&s.started()?n.vel.clone(n.pos).vsub(n.old.pos):(n.old.pos.clone(n.pos).vsub(n.vel),n.vel.mult(t)),i&&n.vel.mult(i),n.vel.vadd(n.acc.mult(r)),n.vel.mult(1/t),n.old.vel.clone(n.vel),n.acc.zero(),n.angular.vel===n.old.angular.vel&&s.started()?n.angular.vel=n.angular.pos-n.old.angular.pos:(n.old.angular.pos=n.angular.pos-n.angular.vel,n.angular.vel*=t),n.angular.vel+=n.angular.acc*r,n.angular.vel/=t,n.old.angular.vel=n.angular.vel,n.angular.acc=0,s.started(!0)):(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0)},integratePositions:function(e,t){for(var n,r=null,i=0,s=e.length;s>i;++i)r=e[i],n=r.state,"static"!==r.treatment&&(n.vel.mult(t),n.old.pos.clone(n.pos),n.pos.vadd(n.vel),n.vel.mult(1/t),n.old.vel.clone(n.vel),n.angular.vel*=t,n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel,n.angular.vel/=t,n.old.angular.vel=n.angular.vel)}}}),n.geometry("point",function(){}),n.body("point",function(e){return{init:function(t){e.init.call(this,t),this.moi=0}}}),n.geometry("circle",function(e){var t={radius:1};return{init:function(r){e.init.call(this,r),this.options.defaults(t),this.options.onChange(function(e){this.radius=e.radius}),this.options(r),this._aabb=n.aabb(),this.radius=this.options.radius},aabb:function(){var e=this.radius;return this._aabb.hw!==e&&(this._aabb=n.aabb(-e,-e,e,e)),n.aabb.clone(this._aabb)},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.clone(e).normalize().mult(this.radius)},getFarthestCorePoint:function(e,t,r){return t=t||n.vector(),t.clone(e).normalize().mult(this.radius-r)}}}),n.geometry("convex-polygon",function(e){var t="Error: The vertices specified do not match that of a _convex_ polygon.",r={};return{init:function(t){var n=this;e.init.call(this,t),this.options.defaults(r),this.options.onChange(function(e){n.setVertices(e.vertices||[])}),this.options(t),n.setVertices(this.options.vertices||[])},setVertices:function(e){var r=n.scratchpad(),i=r.transform(),s=this.vertices=[];if(!n.geometry.isPolygonConvex(e))throw t;i.setRotation(0),i.setTranslation(n.geometry.getPolygonCentroid(e).negate());for(var o=0,u=e.length;u>o;++o)s.push(n.vector(e[o]).translate(i));return this._area=n.geometry.getPolygonArea(s),this._aabb=!1,r.done(),this},aabb:function(e){if(!e&&this._aabb)return n.aabb.clone(this._aabb);var t,r=n.scratchpad(),i=r.vector(),s=r.transform().setRotation(e||0),o=r.vector().set(1,0).rotateInv(s),u=r.vector().set(0,1).rotateInv(s),a=this.getFarthestHullPoint(o,i).proj(o),f=-this.getFarthestHullPoint(o.negate(),i).proj(o),l=this.getFarthestHullPoint(u,i).proj(u),h=-this.getFarthestHullPoint(u.negate(),i).proj(u);return t=n.aabb(f,h,a,l),e||(this._aabb=n.aabb.clone(t)),r.done(),t},getFarthestHullPoint:function(e,t,r){var i,s,o,u=this.vertices,a=u.length,f=2;if(t=t||n.vector(),2>a)return r&&(r.idx=0),t.clone(u[0]);if(s=u[0].dot(e),i=u[1].dot(e),2===a)return o=i>=s?1:0,r&&(r.idx=o),t.clone(u[o]);if(i>=s){for(;a>f&&i>=s;)s=i,i=u[f].dot(e),f++;return i>=s&&f++,o=f-2,r&&(r.idx=f-2),t.clone(u[o])}for(f=a;f>1&&s>=i;)f--,i=s,s=u[f].dot(e);return o=(f+1)%a,r&&(r.idx=o),t.clone(u[o])},getFarthestCorePoint:function(e,t,r){var i,s=n.scratchpad(),o=s.vector(),u=s.vector(),a=this.vertices,f=a.length,l=this._area>0,h={};return t=this.getFarthestHullPoint(e,t,h),o.clone(a[(h.idx+1)%f]).vsub(t).normalize().perp(l),u.clone(a[(h.idx-1+f)%f]).vsub(t).normalize().perp(!l),i=r/(1+o.dot(u)),t.vadd(o.vadd(u).mult(i)),s.done(),t}}}),n.geometry("rectangle",function(e){var t={};return{init:function(n){var r=this;e.init.call(this,n),this.options.defaults(t),this.options.onChange(function(){r.width=r.options.width||1,r.height=r.options.height||1}),this.options(n)},aabb:function(e){if(!e)return n.aabb(this.width,this.height);var t=n.scratchpad(),r=t.vector(),i=t.transform().setRotation(e||0),s=t.vector().set(1,0).rotateInv(i),o=t.vector().set(0,1).rotateInv(i),u=this.getFarthestHullPoint(s,r).proj(s),a=-this.getFarthestHullPoint(s.negate(),r).proj(s),f=this.getFarthestHullPoint(o,r).proj(o),l=-this.getFarthestHullPoint(o.negate(),r).proj(o);return t.done(),n.aabb(a,l,u,f)},getFarthestHullPoint:function(e,t){t=t||new n.vector;var r=e.x,i=e.y;return r=0===r?0:0>r?.5*-this.width:.5*this.width,i=0===i?0:0>i?.5*-this.height:.5*this.height,t.set(r,i)},getFarthestCorePoint:function(e,t,n){var r,i;return t=this.getFarthestHullPoint(e,t),r=t.x,i=t.y,t.x=0===r?0:0>r?r+n:r-n,t.y=0===i?0:0>i?i+n:i-n,t}}}),n.body("circle",function(e){var t={radius:1};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("circle",{radius:r.radius}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),n.body("convex-polygon",function(e){var t={};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("convex-polygon",{vertices:r.vertices}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=n.geometry.getPolygonMOI(this.geometry.vertices)}}}),n.body("rectangle",function(e){var t={};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("rectangle",{width:r.width,height:r.height}),this.recalc()},recalc:function(){var t=this.geometry.width,n=this.geometry.height;e.recalc.call(this),this.moi=(t*t+n*n)*this.mass/12}}}),n.behavior("attractor",function(e){var t={pos:null,strength:1,order:2,max:!1,min:!1};return{init:function(r){var i=this;this._pos=new n.vector,e.init.call(this),this.options.defaults(t),this.options.onChange(function(e){i._maxDist=e.max===!1?1/0:e.max,i._minDist=e.min?e.min:10,i.position(e.pos)}),this.options(r)},position:function(e){var t=this;return e?(this._pos.clone(e),t):this._pos.values()},behave:function(){for(var e,t,r,i=this.getTargets(),s=this.options.order,o=this.options.strength,u=this._minDist,a=this._maxDist,f=n.scratchpad(),l=f.vector(),h=0,p=i.length;p>h;h++)e=i[h],l.clone(this._pos),l.vsub(e.state.pos),t=l.norm(),t>u&&a>t&&(r=o/Math.pow(t,s),e.accelerate(l.normalize().mult(r)));f.done()}}}),n.behavior("body-collision-detection",function(e){var t=[],r=function(e,r){var i=n.util.pairHash(e.uid,r.uid),s=t[i];return s||(s=t[i]=function(t){var i=n.scratchpad(),o=s.tA,u=s.tB,l=i.vector(),h=i.vector(),p=s.marginA,v=s.marginB;return s.useCore?(l=e.geometry.getFarthestCorePoint(t.rotateInv(o),l,p).transform(o),h=r.geometry.getFarthestCorePoint(t.rotate(o).rotateInv(u).negate(),h,v).transform(u)):(l=e.geometry.getFarthestHullPoint(t.rotateInv(o),l).transform(o),h=r.geometry.getFarthestHullPoint(t.rotate(o).rotateInv(u).negate(),h).transform(u)),t.negate().rotate(u),i.done({a:l.values(),b:h.values(),pt:l.vsub(h).values()})},s.tA=n.transform(),s.tB=n.transform()),s.useCore=!1,s.margin=0,s.tA.setTranslation(e.state.pos).setRotation(e.state.angular.pos),s.tB.setTranslation(r.state.pos).setRotation(r.state.angular.pos),s.bodyA=e,s.bodyB=r,s},i=function(e,t){var i,s,o,u=n.scratchpad(),a=u.vector(),f=u.vector(),l=!1,h=e.aabb(),p=Math.min(h.hw,h.hh),v=t.aabb(),m=Math.min(v.hw,v.hh);if(o=r(e,t),a.clone(e.state.pos).vsub(t.state.pos),s=n.gjk(o,a,!0),s.overlap){for(l={bodyA:e,bodyB:t},o.useCore=!0,o.marginA=0,o.marginB=0;s.overlap&&(o.marginA<p||o.marginB<m);)o.marginA<p&&(o.marginA+=1),o.marginB<m&&(o.marginB+=1),s=n.gjk(o,a);if(s.overlap||s.maxIterationsReached)return u.done(!1);i=Math.max(0,o.marginA+o.marginB-s.distance),l.overlap=i,l.norm=a.clone(s.closest.b).vsub(f.clone(s.closest.a)).normalize().values(),l.mtv=a.mult(i).values(),l.pos=a.clone(l.norm).mult(o.margin).vadd(f.clone(s.closest.a)).vsub(e.state.pos).values()}return u.done(l)},s=function(e,t){var r,i=n.scratchpad(),s=i.vector(),o=(i.vector(),!1);return s.clone(t.state.pos).vsub(e.state.pos),r=s.norm()-(e.geometry.radius+t.geometry.radius),s.equals(n.vector.zero)&&s.set(1,0),0>=r&&(o={bodyA:e,bodyB:t,norm:s.normalize().values(),mtv:s.mult(-r).values(),pos:s.normalize().mult(e.geometry.radius).values(),overlap:-r}),i.done(o)},o=function(e,t){return"static"!==e.treatment&&"kinematic"!==e.treatment||"static"!==t.treatment&&"kinematic"!==t.treatment?"circle"===e.geometry.name&&"circle"===t.geometry.name?s(e,t):i(e,t):!1},u={check:"collisions:candidates",channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(u),this.options(t)},connect:function(e){this.options.check===!0?e.on("integrate:velocities",this.checkAll,this):e.on(this.options.check,this.check,this)},disconnect:function(e){this.options.check===!0?e.off("integrate:velocities",this.checkAll):e.off(this.options.check,this.check)},check:function(e){for(var t,r,i=e.candidates,s=this.getTargets(),u=[],a=0,f=i.length;f>a;++a)t=i[a],(s===this._world._bodies||n.util.indexOf(s,t.bodyA)>-1&&n.util.indexOf(s,t.bodyB)>-1)&&(r=o(t.bodyA,t.bodyB),r&&u.push(r));u.length&&this._world.emit(this.options.channel,{collisions:u})},checkAll:function(e){for(var t,n,r,i=this.getTargets(),s=(e.dt,[]),u=0,a=i.length;a>u;u++){t=i[u];for(var f=u+1;a>f;f++)n=i[f],r=o(t,n),r&&s.push(r)}s.length&&this._world.emit(this.options.channel,{collisions:s})}}}),n.behavior("body-impulse-response",function(e){var t={check:"collisions:detected"};return{init:function(n){e.init.call(this),this.options.defaults(t),this.options(n)},applyTo:!1,connect:function(e){e.on(this.options.check,this.respond,this)},disconnect:function(e){e.off(this.options.check,this.respond)},collideBodies:function(e,t,r,i,s,o){var u="static"===e.treatment||"kinematic"===e.treatment,a="static"===t.treatment||"kinematic"===t.treatment,f=n.scratchpad(),l=f.vector().clone(s);if(u&&a)return f.done(),void 0;u?t.state.pos.vadd(l):a?e.state.pos.vsub(l):(l.mult(.5),e.state.pos.vsub(l),t.state.pos.vadd(l));var h,p,d,v=u?0:1/e.moi,m=a?0:1/t.moi,g=u?0:1/e.mass,y=a?0:1/t.mass,b=o?0:e.restitution*t.restitution,w=e.cof*t.cof,E=f.vector().clone(r),S=f.vector().clone(E).perp(),x=f.vector().clone(i),T=f.vector().clone(i).vadd(e.state.pos).vsub(t.state.pos),N=f.vector(),C=e.state.angular.vel,k=t.state.angular.vel,L=f.vector().clone(t.state.vel).vadd(N.clone(T).perp().mult(k)).vsub(e.state.vel).vsub(N.clone(x).perp().mult(C)),A=x.proj(E),O=x.proj(S),M=T.proj(E),_=T.proj(S),D=L.proj(E),P=L.proj(S),H=!1;return D>=0?(f.done(),void 0):(v=1/0===v?0:v,m=1/0===m?0:m,h=-((1+b)*D)/(g+y+v*O*O+m*_*_),u?(t.state.vel.vadd(E.mult(h*y)),t.state.angular.vel-=h*m*_):a?(e.state.vel.vsub(E.mult(h*g)),e.state.angular.vel+=h*v*O):(t.state.vel.vadd(E.mult(h*y)),t.state.angular.vel-=h*m*_,e.state.vel.vsub(E.mult(g*t.mass)),e.state.angular.vel+=h*v*O),w&&P&&(d=P/(g+y+v*A*A+m*M*M),H?h=d:(p=0>P?-1:1,h*=p*w,h=1===p?Math.min(h,d):Math.max(h,d)),u?(t.state.vel.vsub(S.mult(h*y)),t.state.angular.vel-=h*m*M):a?(e.state.vel.vadd(S.mult(h*g)),e.state.angular.vel+=h*v*A):(t.state.vel.vsub(S.mult(h*y)),t.state.angular.vel-=h*m*M,e.state.vel.vadd(S.mult(g*t.mass)),e.state.angular.vel+=h*v*A)),f.done(),void 0)},respond:function(e){for(var t,r=this,i=n.util.shuffle(e.collisions),s=0,o=i.length;o>s;++s)t=i[s],r.collideBodies(t.bodyA,t.bodyB,t.norm,t.pos,t.mtv)}}}),n.behavior("constant-acceleration",function(e){var t={acc:{x:0,y:4e-4}};return{init:function(r){e.init.call(this),this.options.defaults(t),this.options(r),this._acc=n.vector(),this.setAcceleration(this.options.acc),delete this.options.acc},setAcceleration:function(e){return this._acc.clone(e),this},behave:function(){for(var e=this.getTargets(),t=0,n=e.length;n>t;++t)e[t].accelerate(this._acc)}}}),n.behavior("edge-collision-detection",function(e){var t=function(e,t,r){var i,s=e.aabb(),o=n.scratchpad(),u=o.transform(),a=o.vector(),f=o.vector(),l=!1,h=[];return i=s.x+s.hw-t.max.x,i>=0&&(a.set(1,0).rotateInv(u.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:1,y:0},mtv:{x:i,y:0},pos:e.geometry.getFarthestHullPoint(a,f).rotate(u).values()},h.push(l)),i=s.y+s.hh-t.max.y,i>=0&&(a.set(0,1).rotateInv(u.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:0,y:1},mtv:{x:0,y:i},pos:e.geometry.getFarthestHullPoint(a,f).rotate(u).values()},h.push(l)),i=t.min.x-(s.x-s.hw),i>=0&&(a.set(-1,0).rotateInv(u.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:-1,y:0},mtv:{x:-i,y:0},pos:e.geometry.getFarthestHullPoint(a,f).rotate(u).values()},h.push(l)),i=t.min.y-(s.y-s.hh),i>=0&&(a.set(0,-1).rotateInv(u.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:0,y:-1},mtv:{x:0,y:-i},pos:e.geometry.getFarthestHullPoint(a,f).rotate(u).values()},h.push(l)),o.done(),h},r=function(e,n,r){return t(e,n,r)},i={aabb:null,restitution:.99,cof:1,channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(i),this.options(t),this.setAABB(this.options.aabb),this.restitution=this.options.restitution,this.body=n.body("point",{treatment:"static",restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(e){if(!e)throw"Error: aabb not set";return this._edges={min:{x:e.x-e.hw,y:e.y-e.hh},max:{x:e.x+e.hw,y:e.y+e.hh}},this},connect:function(e){e.on("integrate:velocities",this.checkAll,this)},disconnect:function(e){e.off("integrate:velocities",this.checkAll)},checkAll:function(e){for(var t,n,i=this.getTargets(),s=(e.dt,[]),o=this._edges,u=this.body,a=0,f=i.length;f>a;a++)t=i[a],"dynamic"===t.treatment&&(n=r(t,o,u),n&&s.push.apply(s,n));s.length&&this._world.emit(this.options.channel,{collisions:s})}}}),n.behavior("interactive",function(e){if(!t)return{};var r={el:null,moveThrottle:10,minVel:{x:-5,y:-5},maxVel:{x:5,y:5}},i=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return{left:t,top:n}},s=function(e){var t=i(e.target),n=e.changedTouches&&e.changedTouches[0]||e,r=n.pageX-t.left,s=n.pageY-t.top;return{x:r,y:s}};return{init:function(i){var o,u,l=this;if(e.init.call(this),this.options.defaults(r),this.options(i),this.mousePos=new n.vector,this.mousePosOld=new n.vector,this.offset=new n.vector,this.el="string"==typeof this.options.el?t.getElementById(this.options.el):this.options.el,!this.el)throw"No DOM element specified";var h=function(e){var t,r=s(e);l._world&&(t=l._world.findOne({$at:new n.vector(r.x,r.y)}),t?(o=t.treatment,t.treatment="kinematic",t.state.vel.zero(),t.state.angular.vel=0,l.body=t,l.mousePos.clone(r),l.offset.clone(r).vsub(t.state.pos),r.body=t,l._world.emit("interact:grab",r)):l._world.emit("interact:poke",r))},p=n.util.throttle(function(e){var t=s(e);l.body&&(u=n.util.ticker.now(),l.mousePosOld.clone(l.mousePos),l.mousePos.set(t.x,t.y),t.body=l.body),l._world.emit("interact:move",t)},l.options.moveThrottle),v=function(e){var t=s(e),r=Math.max(n.util.ticker.now()-u,l.options.moveThrottle);l.mousePos.set(t.x,t.y),l.body&&(l.body.treatment=o,l.body.state.vel.clone(l.mousePos).vsub(l.mousePosOld).mult(1/r),l.body.state.vel.clamp(l.options.minVel,l.options.maxVel),l.body=!1),l._world&&l._world.emit("interact:release",t)};this.el.addEventListener("mousedown",h),this.el.addEventListener("touchstart",h),this.el.addEventListener("mousemove",p),this.el.addEventListener("touchmove",p),this.el.addEventListener("mouseup",v),this.el.addEventListener("touchend",v)},connect:function(e){e.on("integrate:positions",this.behave,this)},disconnect:function(e){e.off("integrate:positions",this.behave)},behave:function(e){var t,n=this,r=Math.max(e.dt,n.options.moveThrottle);n.body&&(t=n.body.state,t.vel.clone(n.mousePos).vsub(n.offset).vsub(t.pos).mult(1/r))}}}),n.behavior("newtonian",function(e){var t={strength:1,max:!1,min:!1};return{init:function(n){var r=this;e.init.call(this),this.options.defaults(t),this.options.onChange(function(e){r._maxDistSq=e.max===!1?1/0:e.max*e.max,r._minDistSq=e.min?e.min*e.min:100*e.strength}),this.options(n)},behave:function(){for(var e,t,r,i,s=this.getTargets(),o=this.options.strength,u=this._minDistSq,a=this._maxDistSq,f=n.scratchpad(),l=f.vector(),h=0,p=s.length;p>h;h++){e=s[h];for(var d=h+1;p>d;d++)t=s[d],l.clone(t.state.pos),l.vsub(e.state.pos),r=l.normSq(),r>u&&a>r&&(i=o/r,e.accelerate(l.normalize().mult(i*t.mass)),t.accelerate(l.mult(e.mass/t.mass).negate()))}f.done()}}}),n.behavior("sweep-prune",function(e){var t=1,r=function(){return t++},i={x:0,y:1},s=2,o=n.util.pairHash;return{init:function(t){e.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(t),this.encounters=[],this.candidates=[],this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists=[];for(var e=0;s>e;++e)this.intervalLists[e]=[]},connect:function(e){e.on("add:body",this.trackBody,this),e.on("remove:body",this.untrackBody,this),e.on("integrate:velocities",this.sweep,this);for(var t=e.getBodies(),n=0,r=t.length;r>n;++n)this.trackBody({body:t[n]})},disconnect:function(e){e.off("add:body",this.trackBody),e.off("remove:body",this.untrackBody),e.off("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){for(var e,t,n,r,i,o,u,a,l,c=0;s>c;++c)for(e=this.intervalLists[c],n=0,t=e.length,l=c;++n<t;){for(i=e[n],o=i.val.get(l),r=n,u=e[r-1],a=u&&u.val.get(l);r>0&&(a>o||a===o&&u.type&&!i.type);)e[r]=u,r--,u=e[r-1],a=u&&u.val.get(l);e[r]=i}},getPair:function(e,t,n){var r=o(e.id,t.id);if(r===!1)return null;var i=this.pairs[r];if(!i){if(!n)return null;i=this.pairs[r]={bodyA:e.body,bodyB:t.body,flag:1}}return i},checkOverlaps:function(){var e,t,n,r,o,u,a,l,c,h=1<<i.z+1<<i.y+1<<i.x+1,p=this.encounters,d=0,v=this.candidates;p.length=v.length=0;for(var m=0;s>m;++m)for(e=0===m,o=this.intervalLists[m],a=0,u=o.length;u>a;a++)if(r=o[a],t=r.tracker,r.type)for(l=d,l=d-1;l>=0;l--)n=p[l],n===t?(d-1>l?p[l]=p.pop():p.pop(),d--):(c=this.getPair(t,n,e),c&&(c.flag>h&&(c.flag=1),c.flag=c.flag<<m+1,c.flag===h&&v.push(c)));else d=p.push(t);return v},updateIntervals:function(){for(var e,t,r,i=n.scratchpad(),s=i.vector(),o=i.vector(),u=this.tracked,a=u.length;--a>=0;)e=u[a],t=e.interval,s.clone(e.body.state.pos),r=e.body.aabb(),o.set(r.hw,r.hh),t.min.val.clone(s).vsub(o),t.max.val.clone(s).vadd(o);i.done()},trackBody:function(e){var t=e.body,i={id:r(),body:t},o={min:{type:!1,val:n.vector(),tracker:i},max:{type:!0,val:n.vector(),tracker:i}};i.interval=o,this.tracked.push(i);for(var u=0;s>u;++u)this.intervalLists[u].push(o.min,o.max)},untrackBody:function(e){for(var t,n,r,i,o=e.body,u=this.tracked,a=0,l=u.length;l>a;++a)if(r=u[a],r.body===o){u.splice(a,1);for(var c=0;s>c;++c){i=0,t=this.intervalLists[c];for(var h=0,p=t.length;p>h;++h)if(n=t[h],n===r.interval.min||n===r.interval.max){if(t.splice(h,1),h--,l--,i>0)break;i++}}break}},sweep:function(){var e,t=this;e=t.broadPhase(),e.length&&this._world.emit(this.options.channel,{candidates:e})}}}),n.behavior("verlet-constraints",function(e){var t=2*Math.PI,r={iterations:2};return{init:function(t){e.init.call(this),this.options.defaults(r),this.options(t),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(e){var t=e.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';e.on("integrate:positions",this.resolve,this)},disconnect:function(e){e.off("integrate:positions",this.resolve)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(e,t,r,i){var s;return e&&t?(s={id:n.util.uniqueId("dis-constraint"),type:"dis",bodyA:e,bodyB:t,stiffness:r||.5,targetLength:i||t.state.pos.dist(e.state.pos)},s.targetLengthSq=s.targetLength*s.targetLength,this._distanceConstraints.push(s),s):!1},angleConstraint:function(e,t,r,i,s){var o;return e&&t?(o={id:n.util.uniqueId("ang-constraint"),type:"ang",bodyA:e,bodyB:t,bodyC:r,stiffness:i||.5,targetAngle:s||t.state.pos.angle2(e.state.pos,r.state.pos)},this._angleConstraints.push(o),o):!1},remove:function(e){var t,r,i,s,o;if(i=n.util.isObject(e),r=i?e.type:e.substr(0,3),t="ang"===r?this._angleConstraints:this._distanceConstraints,i){for(s=0,o=t.length;o>s;++s)if(t[s]===e)return t.splice(s,1),this}else for(s=0,o=t.length;o>s;++s)if(t[s].id===e)return t.splice(s,1),this;return this},resolveAngleConstraints:function(e){for(var r,i,s,o,u=this._angleConstraints,a=n.scratchpad(),f=a.transform(),l=0,h=u.length;h>l;++l)r=u[l],i=r.bodyB.state.pos.angle2(r.bodyA.state.pos,r.bodyC.state.pos),s=i-r.targetAngle,s&&(s<=-Math.PI?s+=t:s>=Math.PI&&(s-=t),f.setTranslation(r.bodyB.state.pos),s*=-e*r.stiffness,"dynamic"===r.bodyA.treatment&&"dynamic"===r.bodyB.treatment&&"dynamic"===r.bodyC.treatment&&(o=1/(r.bodyA.mass+r.bodyB.mass+r.bodyC.mass)),"dynamic"===r.bodyA.treatment&&(i="dynamic"===r.bodyB.treatment&&"dynamic"===r.bodyC.treatment?s*(r.bodyB.mass+r.bodyC.mass)*o:"dynamic"!==r.bodyB.treatment?s*r.bodyC.mass/(r.bodyC.mass+r.bodyA.mass):s*r.bodyB.mass/(r.bodyB.mass+r.bodyA.mass),f.setRotation(i),r.bodyA.state.pos.translateInv(f),r.bodyA.state.pos.rotate(f),r.bodyA.state.pos.translate(f)),"dynamic"===r.bodyC.treatment&&(i="dynamic"===r.bodyA.treatment&&"dynamic"===r.bodyB.treatment?-s*(r.bodyB.mass+r.bodyA.mass)*o:"dynamic"!==r.bodyB.treatment?-s*r.bodyA.mass/(r.bodyC.mass+r.bodyA.mass):-s*r.bodyB.mass/(r.bodyB.mass+r.bodyC.mass),f.setRotation(i),r.bodyC.state.pos.translateInv(f),r.bodyC.state.pos.rotate(f),r.bodyC.state.pos.translate(f)),"dynamic"===r.bodyB.treatment&&(i="dynamic"===r.bodyA.treatment&&"dynamic"===r.bodyC.treatment?s*(r.bodyA.mass+r.bodyC.mass)*o:"dynamic"!==r.bodyA.treatment?s*r.bodyC.mass/(r.bodyC.mass+r.bodyB.mass):s*r.bodyA.mass/(r.bodyA.mass+r.bodyC.mass),f.setRotation(i).setTranslation(r.bodyA.state.pos),r.bodyB.state.pos.translateInv(f),r.bodyB.state.pos.rotate(f),r.bodyB.state.pos.translate(f),f.setTranslation(r.bodyC.state.pos),r.bodyB.state.pos.translateInv(f),r.bodyB.state.pos.rotateInv(f),r.bodyB.state.pos.translate(f)));a.done()},resolveDistanceConstraints:function(e){for(var t,r,i,s,o=this._distanceConstraints,u=n.scratchpad(),a=u.vector(),f=0,l=o.length;l>f;++f)t=o[f],a.clone(t.bodyB.state.pos).vsub(t.bodyA.state.pos),r=a.normSq()||1e-4*Math.random(),i=e*t.stiffness*(r-t.targetLengthSq)/r,a.mult(i),s="dynamic"!==t.bodyA.treatment||"dynamic"!==t.bodyB.treatment?1:t.bodyB.mass/(t.bodyA.mass+t.bodyB.mass),"dynamic"===t.bodyA.treatment&&("dynamic"===t.bodyB.treatment&&a.mult(s),t.bodyA.state.pos.vadd(a),"dynamic"===t.bodyB.treatment&&a.mult(1/s)),"dynamic"===t.bodyB.treatment&&("dynamic"===t.bodyA.treatment&&a.mult(1-s),t.bodyB.state.pos.vsub(a));u.done()},shuffleConstraints:function(){this._distanceConstraints=n.util.shuffle(this._distanceConstraints),this._angleConstraints=n.util.shuffle(this._angleConstraints)},resolve:function(){for(var e=this.options.iterations,t=1/e,n=0;e>n;n++)this.resolveDistanceConstraints(t),this.resolveAngleConstraints(t)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),n.integrator("improved-euler",function(e){return{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){for(var n,r=1-this.options.drag,i=null,s=0,o=e.length;o>s;++s)i=e[s],n=i.state,"static"!==i.treatment?(n.old.vel.clone(n.vel),n.old.acc.clone(n.acc),n.vel.vadd(n.acc.mult(t)),r&&n.vel.mult(r),n.acc.zero(),n.old.angular.vel=n.angular.vel,n.angular.vel+=n.angular.acc*t,n.angular.acc=0):(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0)},integratePositions:function(e,t){for(var r,i=.5*t*t,s=null,o=n.scratchpad(),u=o.vector(),a=0,f=e.length;f>a;++a)s=e[a],r=s.state,"static"!==s.treatment&&(r.old.pos.clone(r.pos),u.clone(r.old.vel),r.pos.vadd(u.mult(t)).vadd(r.old.acc.mult(i)),r.old.acc.zero(),r.old.angular.pos=r.angular.pos,r.angular.pos+=r.old.angular.vel*t+r.old.angular.acc*i,r.old.angular.acc=0);o.done()}}}),n.renderer("canvas",function(e){if(!t)return{};var r=2*Math.PI,i=function(e,n){var r=t.createElement(e||"div");return n&&(r.innerHTML=n),r},s={white:"#fff",violet:"#542437",blue:"#53777A"},o={debug:!1,metaEl:null,styles:{circle:{strokeStyle:s.blue,lineWidth:1,fillStyle:s.blue,angleIndicator:s.white},"convex-polygon":{strokeStyle:s.violet,lineWidth:1,fillStyle:s.violet,angleIndicator:s.white}},offset:{x:0,y:0}},u=function(e,t){return n.util.isPlainObject(t)?n.util.extend({},e,t,u):void 0!==t?t:e};return{init:function(r){if(e.init.call(this,r),this.options=n.util.extend({},o,this.options,u),this.options.offset=n.vector(this.options.offset),this.hiddenCanvas=t.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100,!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var s=this.el;if("CANVAS"!==s.nodeName.toUpperCase()&&(s=t.createElement("canvas"),this.el.appendChild(s),"string"==typeof this.options.el&&this.el===t.body&&(s.id=this.options.el),this.el=s),this.ctx=s.getContext("2d"),this.els={},this.options.meta){var f=this.options.metaEl||i();f.className="pjs-meta",this.els.fps=i("span"),this.els.ipf=i("span"),f.appendChild(i("span","fps: ")),f.appendChild(this.els.fps),f.appendChild(i("br")),f.appendChild(i("span","ipf: ")),f.appendChild(this.els.ipf),s.parentNode.insertBefore(f,s)}this._layers={},this.addLayer("main",this.el),this.resize(this.options.width,this.options.height)},layer:function(e){return e in this._layers?this._layers[e]:null},addLayer:function(e,r,i){var s=this,o=[],u=n.util.extend({},this.options.styles),a={id:e,el:r||t.createElement("canvas"),options:n.util.options({width:this.el.width,height:this.el.height,manual:!1,autoResize:!0,follow:null,offset:null,scale:1,zIndex:1})(i)};if(e in this._layers)throw'Layer "'+e+'" already added.';return this.el.parentNode.insertBefore(a.el,this.el),a.el.style.position="absolute",a.el.style.zIndex=a.options.zIndex,a.el.className+=" pjs-layer-"+a.id,a.ctx=a.el.getContext("2d"),a.ctx.scale(1,1),a.el.width=a.options.width,a.el.height=a.options.height,a.bodies=o,a.reset=function(e){return o=e||[],a},a.addToStack=function(e){return n.util.isArray(e)?o.push.apply(o,e):o.push(e),a},a.removeFromStack=function(e){var t,r;if(n.util.isArray(e))for(t=0,r=e.length;r>t;++t)a.removeFromStack(e[t]);else t=n.util.indexOf(o,e),t>-1&&o.splice(t,1);return a},a.render=function(e){var t,r,i,l=n.scratchpad(),p=l.vector().set(0,0),d=a.options.scale,v=o.length,m=v||"main"!==a.id?o:s._world._bodies;if(a.options.manual)return l.done(),a;for(a.options.offset&&("center"===a.options.offset?p.add(.5*a.el.width,.5*a.el.height).mult(1/d):p.vadd(a.options.offset).mult(1/d)),a.options.follow&&p.vsub(a.options.follow.state.pos),e!==!1&&a.ctx.clearRect(0,0,a.el.width,a.el.height),1!==d&&(a.ctx.save(),a.ctx.scale(d,d)),i=0,v=m.length;v>i;++i)t=m[i],t.hidden||(r=t.view||(t.view=s.createView(t.geometry,t.styles||u[t.geometry.name])),s.drawBody(t,t.view,a.ctx,p));return 1!==d&&a.ctx.restore(),l.done(),a},this._layers[e]=a,a},removeLayer:function(e){var t=e.id?e.id:e,n=this._layers[t].el;return n!==this.el&&n.parentNode.removeChild(n),delete this._layers[t],this},resize:function(e,t){var n;for(var r in this._layers)n=this._layers[r],n.options.autoResize&&(n.el.width=e,n.el.height=t);return this},setStyle:function(e,t){t=t||this.ctx,n.util.isObject(e)?(e.strokeStyle=e.lineWidth?e.strokeStyle:"rgba(0,0,0,0)",n.util.extend(t,e)):(t.fillStyle=t.strokeStyle=e,t.lineWidth=1)},drawCircle:function(e,t,n,i,s){s=s||this.ctx,s.beginPath(),this.setStyle(i,s),s.arc(e,t,n,0,r,!1),s.closePath(),s.stroke(),s.fill()},drawPolygon:function(e,t,n){var r=e[0],i=r.x,s=r.y,o=e.length;n=n||this.ctx,n.beginPath(),this.setStyle(t,n),n.moveTo(i,s);for(var u=1;o>u;++u)r=e[u],i=r.x,s=r.y,n.lineTo(i,s);o>2&&n.closePath(),n.stroke(),n.fill()},drawRect:function(e,t,n,r,i,s){var o=.5*n,u=.5*r;s=s||this.ctx,this.setStyle(i,s),s.beginPath(),s.rect(e-o,t-u,n,r),s.closePath(),s.stroke(),s.fill()},drawLine:function(e,t,n,r){var i=e.x,s=e.y;r=r||this.ctx,r.beginPath(),this.setStyle(n,r),r.moveTo(i,s),i=t.x,s=t.y,r.lineTo(i,s),r.stroke(),r.fill()},createView:function(e,t){var n,r=e.aabb(),i=r.hw+Math.abs(r.x),s=r.hh+Math.abs(r.y),o=i+1,u=s+1,a=this.hiddenCtx,f=this.hiddenCanvas,l=e.name;return t=t||this.options.styles[l]||{},t.src?(n=new Image,n.src=t.src,t.width&&(n.width=t.width),t.height&&(n.height=t.height),n):(o+=0|t.lineWidth,u+=0|t.lineWidth,f.width=2*i+2+(0|2*t.lineWidth),f.height=2*s+2+(0|2*t.lineWidth),a.save(),a.translate(o,u),"circle"===l?this.drawCircle(0,0,e.radius,t,a):"convex-polygon"===l?this.drawPolygon(e.vertices,t,a):"rectangle"===l&&this.drawRect(0,0,e.width,e.height,t,a),t.angleIndicator&&(a.beginPath(),this.setStyle(t.angleIndicator,a),a.moveTo(0,0),a.lineTo(i,0),a.closePath(),a.stroke()),a.restore(),n=new Image(f.width,f.height),n.src=f.toDataURL("image/png"),n)},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:function(e,t,n,r){var i,s,o,u,a=e.state.pos,f=e.state.vel,l=this._interpolateTime||0;r=r||this.options.offset,n=n||this.ctx,i=a.x+r.x+f.x*l,s=a.y+r.y+f.y*l,o=e.state.angular.pos+e.state.angular.vel*l,n.save(),n.translate(i,s),n.rotate(o),n.drawImage(t,-t.width/2,-t.height/2),n.restore(),this.options.debug&&(u=e.aabb(),this.drawRect(u.x,u.y,2*u.hw,2*u.hh,"rgba(0, 0, 255, 0.3)"),e._debugView=e._debugView||this.createView(e.geometry,"rgba(255, 0, 0, 0.5)"),n.save(),n.translate(a.x+r.x,a.y+r.y),n.rotate(e.state.angular.pos),n.drawImage(e._debugView,.5*-e._debugView.width,.5*-e._debugView.height),n.restore())},render:function(e,t){this._world.emit("beforeRender",{renderer:this,meta:t}),this.options.meta&&this.drawMeta(t),this._interpolateTime=t.interpolateTime;for(var n in this._layers)this._layers[n].render();return this}}}),n.renderer("dom",function(e){if(!t)return{};var n={},r=t.createElement("div"),i=function(e){return e.replace(/(?:^|\s)\w/g,function(e){return e.toUpperCase()})},s=function(e){if(n[e])return n[e];for(var t,s=["Webkit","Moz","Ms","O"],o=0,u=s.length;u>o;++o)if(t=s[o]+i(e),t in r.style)return n[e]=t;return t in r.style?n[e]=e:!1},o="pjs-",u="px",a=s("transform"),f=function(e,n){var r=t.createElement(e||"div");return n&&(r.innerHTML=n),r};return{init:function(t){e.init.call(this,t);var n=this.el;if(n.style.position="relative",n.style.overflow="hidden",n.style[a]="translateZ(0)",n.style.width=this.options.width+u,n.style.height=this.options.height+u,this.els={},t.meta){var r=f();r.className="pjs-meta",this.els.fps=f("span"),this.els.ipf=f("span"),r.appendChild(f("span","fps: ")),r.appendChild(this.els.fps),r.appendChild(f("br")),r.appendChild(f("span","ipf: ")),r.appendChild(this.els.ipf),n.appendChild(r)}},circleProperties:function(e,t){var n=t.aabb();e.style.width=2*n.hw+u,e.style.height=2*n.hh+u,e.style.marginLeft=-n.hw+u,e.style.marginTop=-n.hh+u},rectangleProperties:function(e,t){var n=t.aabb();e.style.width=2*n.hw+u,e.style.height=2*n.hh+u,e.style.marginLeft=-n.hw+u,e.style.marginTop=-n.hh+u},createView:function(e){var t=f(),n=e.name+"Properties";return t.className=o+e.name,t.style.position="absolute",t.style.top="0px",t.style.left="0px",this[n]&&this[n](t,e),this.el.appendChild(t),t},connect:function(e){e.on("add:body",this.attach,this),e.on("remove:body",this.detach,this)},disconnect:function(e){e.off("add:body",this.attach),e.off("remove:body",this.detach)},detach:function(e){var t=e.nodeType&&e||e.body&&e.body.view,n=t&&t.parentNode;return t&&n&&n.removeChild(t),this},attach:function(e){var t=e.nodeType&&e||e.body&&e.body.view;return t&&this.el.appendChild(t),this},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:function(e,t){var n,r,i,s=e.state.pos,o=e.state.vel,u=this._interpolateTime;n=s.x+o.x*u,r=s.y+o.y*u,i=e.state.angular.pos+e.state.angular.vel*u,t.style[a]="translate("+n+"px,"+r+"px) rotate("+i+"rad)"}}}),n.renderer("pixi",function(e){if(!t)return{};2*Math.PI;var r={debug:!1,metaEl:null,offset:{x:0,y:0},styles:{color:"0x66FF99",point:"0xE8900C",circle:{strokeStyle:"0xE8900C",lineWidth:3,fillStyle:"0xD5DE4C",angleIndicator:"0xE8900C"},"convex-polygon":{strokeStyle:"0xE8900C",lineWidth:3,fillStyle:"0xD5DE4C",angleIndicator:"0xE8900C"}}},i=function(e,t){return n.util.isPlainObject(t)?n.util.extend({},e,t,i):void 0!==t?t:e};return{init:function(s){if("undefined"==typeof PIXI)throw"PIXI obj not present - cannot continue ";e.init.call(this,s),this.options=n.util.extend({},r,this.options,i),this.options.offset=n.vector(this.options.offset),this.stage=new PIXI.Stage(this.options.styles.color),this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height),this.meta={},"CANVAS"===this.el.nodeName?this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height,this.el):(this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height),null!==this.el?this.el.appendChild(this.renderer.view):t.body.appendChild(this.renderer.view))},loadSpriteSheets:function(e,t){if(!n.util.isArray(e))throw"Spritesheets must be defined in arrays";var r=this,i=new PIXI.AssetLoader(e);return i.load(),i.on("onComplete",function(){r.assetsLoaded=!0,t()}),r},drawBody:function(e,t){var n,r,i,s=e.state.pos,o=e.state.vel,u=this._interpolateTime||0;n=s.x+o.x*u,r=s.y+o.y*u,i=e.state.angular.pos+e.state.angular.vel*u,t.position.x=n,t.position.y=r,t.rotation=i},render:function(t,n){e.render.call(this,t,n),this.renderer.render(this.stage)},createCircle:function(e,t,n,r){var i=new PIXI.Graphics;return i.beginFill(r.fillStyle),i.lineStyle(r.lineWidth,r.strokeStyle),i.drawCircle(e,t,n),i.pivot.x=e/2+n/2,i.pivot.y=t/2+n/2,i},createPolygon:function(e,t){var n=e[0],r=n.x,i=n.y,s=e.length,o={x:r,y:i},u=new PIXI.Graphics;u.beginFill(t.fillStyle),u.lineStyle(t.lineWidth,t.strokeStyle),u.moveTo(r,i);for(var a=1;s>a;++a)n=e[a],r=n.x,i=n.y,u.lineTo(r,i);return s>2&&u.lineTo(o.x,o.y),u.endFill(),u},createLine:function(e,t,n){var r=e.x,i=e.y,s=new PIXI.Graphics;return s.beginFill(n.fillStyle),s.lineStyle(n.lineWidth,n.strokeStyle),s.moveTo(r,i),r=t.x,i=t.y,s.lineTo(r,i),s.endFill(),s},createView:function(e){var t=null,n=e.aabb(),r=n.hw+Math.abs(n.x),i=n.hh+Math.abs(n.y),s=r+1,o=i+1,u=e.name,a=a||this.options.styles[u];if(s+=0|a.lineWidth,o+=0|a.lineWidth,"circle"===u?t=this.createCircle(s,o,e.radius,a):"convex-polygon"===u&&(t=this.createPolygon(e.vertices,a)),a.angleIndicator&&(t.beginFill(a.angleIndicator),t.moveTo(s/2,5+a.lineWidth),t.lineTo(s/2+e.radius/2,e.radius),t.endFill()),t)return this.stage.addChild(t),t;throw"Invalid view name passed."},drawMeta:function(e){if(this.meta.loaded)this.meta.fps.setText("FPS: "+e.fps.toFixed(2)),this.meta.ipf.setText("IPF: "+e.ipf);else{var t={font:"18px Snippet",fill:"white",align:"left"};this.meta.fps=new PIXI.Text("FPS: "+e.fps.toFixed(2),t),this.meta.fps.position.x=15,this.meta.fps.position.y=5,this.meta.ipf=new PIXI.Text("IPF: "+e.ipf,t),this.meta.ipf.position.x=15,this.meta.ipf.position.y=30,this.stage.addChild(this.meta.fps),this.stage.addChild(this.meta.ipf),this.meta.loaded=!0}},createDisplay:function(e,t){var n=null,r=null;switch(e){case"sprite":return r=PIXI.Texture.fromImage(t.texture),n=new PIXI.Sprite(r),t.anchor&&(n.anchor.x=t.anchor.x,n.anchor.y=t.anchor.y),t.container?t.container.addChild(n):this.stage.addChild(n),n;case"movieclip":if(!this.assetsLoaded)throw"No assets have been loaded. Use loadSpritesheet() first";var i=[],s=0;for(s;s<t.frames.length;s++)r=PIXI.Texture.fromFrame(t.frames[s]),i.push(r);return n=new PIXI.MovieClip(i),t.anchor&&(n.anchor.x=t.anchor.x,n.anchor.y=t.anchor.y),t.container?t.container.addChild(n):this.stage.addChild(n),n;default:throw"Invalid PIXI.DisplayObject passed"}},centerAnchor:function(e){null!==e&&(e.anchor.x=.5,e.anchor.y=.5)}}}),n});